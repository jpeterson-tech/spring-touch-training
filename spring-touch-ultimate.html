<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Touch Training - Ultimate Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2c 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2d5016;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px;
        }

        .badge.premium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .role-selector {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .role-btn {
            flex: 1;
            padding: 30px;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .role-btn:hover {
            border-color: #4a7c2c;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(74, 124, 44, 0.3);
        }

        .role-btn.active {
            border-color: #2d5016;
            background: #f0fdf4;
        }

        .role-btn h3 {
            color: #2d5016;
            margin-bottom: 10px;
        }

        .user-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 2fr 4fr;
            gap: 20px;
        }

        .user-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-input label {
            color: #2d5016;
            font-weight: 600;
        }

        .user-input input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #e6f7ed 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #4a7c2c;
        }

        .stat-box .label {
            color: #2d5016;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .stat-box .value {
            color: #2d5016;
            font-size: 1.8em;
            font-weight: 700;
        }

        .tabs {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .tab-buttons {
            display: flex;
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: white;
            color: #2d5016;
            border-bottom: 3px solid #4a7c2c;
        }

        .tab-button.manager-only {
            background: #fef3c7;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #2d5016;
            margin-bottom: 20px;
        }

        .scenario-selector {
            margin-bottom: 20px;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .difficulty-badge.easy {
            background: #c6f6d5;
            color: #22543d;
        }

        .difficulty-badge.medium {
            background: #feebc8;
            color: #7c2d12;
        }

        .difficulty-badge.hard {
            background: #fed7d7;
            color: #742a2a;
        }

        .scenario-selector label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .scenario-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .adaptive-notice {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f59e0b;
        }

        .scenario-info {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4a7c2c;
        }

        .metrics-display {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .receptiveness-bar-container {
            background: #e2e8f0;
            height: 20px;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .receptiveness-bar {
            background: linear-gradient(90deg, #f56565 0%, #ed8936 33%, #ecc94b 66%, #48bb78 100%);
            height: 100%;
            width: 50%;
            transition: width 0.5s;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .status.waiting {
            background: #bee3f8;
            color: #2c5282;
        }

        .status.speaking {
            background: #c6f6d5;
            color: #22543d;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a7c2c 0%, #2d5016 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 124, 44, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-area textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .conversation {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            line-height: 1.6;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.customer {
            background: #fff5f5;
            border-left: 4px solid #f56565;
        }

        .message.agent {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
        }

        .message strong {
            display: block;
            margin-bottom: 5px;
        }

        .upload-zone {
            border: 3px dashed #4a7c2c;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0fdf4;
        }

        .upload-zone:hover {
            background: #e6f7ed;
            border-color: #2d5016;
        }

        .upload-zone.dragover {
            background: #d1fae5;
            transform: scale(1.02);
        }

        .call-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .call-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4a7c2c;
        }

        .history-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .history-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4a7c2c;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: #e6f7ed;
            transform: translateX(5px);
        }

        .history-item .date {
            color: #718096;
            font-size: 0.9em;
        }

        .history-item .score {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d5016;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #4a7c2c;
        }

        .insight-card h4 {
            color: #2d5016;
            margin-bottom: 10px;
        }

        .chart-container {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .leaderboard {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .leaderboard-rank {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d5016;
            width: 40px;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
        }

        .leaderboard-score {
            font-size: 1.2em;
            font-weight: 700;
            color: #4a7c2c;
        }

        .team-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #e6f7ed 100%);
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #4a7c2c;
            text-align: center;
        }

        .metric-card .value {
            font-size: 3em;
            font-weight: 700;
            color: #2d5016;
            margin-bottom: 10px;
        }

        .metric-card .label {
            color: #4a5568;
            font-weight: 600;
        }

        .agent-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .agent-table th {
            background: #2d5016;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .agent-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .agent-table tr:hover {
            background: #f0fdf4;
        }

        .progress-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a7c2c 0%, #2d5016 100%);
            transition: width 0.3s;
        }

        .alert-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-box.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-box.success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .alert-box.info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåø Spring Touch Training Center - Ultimate Edition</h1>
            <p>Complete AI Training System with Analytics, Adaptive Learning & Team Management</p>
            <div>
                <span class="badge">üìä Progress Tracking</span>
                <span class="badge">üß† Adaptive Difficulty</span>
                <span class="badge">üèÜ Leaderboard</span>
                <span class="badge premium">üìà Team Analytics</span>
                <span class="badge premium">üìÅ Excel Export</span>
                <span class="badge premium">üé§ Call Upload</span>
                <span class="badge premium">üëî Manager Dashboard</span>
            </div>
        </div>

        <div class="role-selector">
            <div class="role-btn active" onclick="setRole('agent')" id="roleAgent">
                <h3>üéß I'm an Agent</h3>
                <p>Practice retention skills and track my progress</p>
            </div>
            <div class="role-btn" onclick="setRole('manager')" id="roleManager">
                <h3>üëî I'm a Manager</h3>
                <p>View team analytics and manage training</p>
            </div>
        </div>

        <div class="user-panel">
            <div class="user-input">
                <label for="agentName">Your Name:</label>
                <input type="text" id="agentName" placeholder="Enter your name" onchange="loadUserData()">
                <button class="btn btn-primary" onclick="loadUserData()">Load My Progress</button>
            </div>
            <div class="user-stats" id="userStats">
                <div class="stat-box">
                    <div class="label">Total Sessions</div>
                    <div class="value" id="totalSessions">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Avg Score</div>
                    <div class="value" id="avgScore">0%</div>
                </div>
                <div class="stat-box">
                    <div class="label">Best Scenario</div>
                    <div class="value" id="bestScenario" style="font-size: 1.2em;">-</div>
                </div>
                <div class="stat-box">
                    <div class="label">Improvement</div>
                    <div class="value" id="improvement">-</div>
                </div>
                <div class="stat-box">
                    <div class="label">Current Level</div>
                    <div class="value" id="currentLevel" style="font-size: 1.2em;">Beginner</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('training')">üéØ Training</button>
                <button class="tab-button" onclick="switchTab('history')">üìö My History</button>
                <button class="tab-button" onclick="switchTab('insights')">üí° Insights</button>
                <button class="tab-button" onclick="switchTab('leaderboard')">üèÜ Leaderboard</button>
                <button class="tab-button" onclick="switchTab('upload')">üé§ Upload Calls</button>
                <button class="tab-button manager-only" onclick="switchTab('teamanalytics')" style="display: none;" id="tabTeamAnalytics">üìä Team Analytics</button>
                <button class="tab-button manager-only" onclick="switchTab('managerdash')" style="display: none;" id="tabManagerDash">üëî Manager Dashboard</button>
            </div>

            <div id="training" class="tab-content active">
                <div id="adaptiveNotice" class="adaptive-notice" style="display: none;">
                    <strong>üéØ Adaptive Training Active:</strong> <span id="adaptiveMessage"></span>
                </div>

                <div class="scenario-selector">
                    <label for="scenario">Select Scenario:</label>
                    <select id="scenario" onchange="updateScenarioInfo()">
                        <option value="auto">ü§ñ Auto-Select (Adaptive)</option>
                        <option value="moving">Moving (Random: Local or Out of State)</option>
                        <option value="financial">Budget Concerns - Lost Job</option>
                        <option value="bad_service">Missed Appointments</option>
                        <option value="not_working">Weeds Still Present</option>
                        <option value="competitor">Cheaper Competitor Offer</option>
                    </select>
                </div>

                <div class="scenario-info" id="scenarioInfo">
                    <h3>Ready to Begin</h3>
                    <p>Enter your name above and click "Start Training"</p>
                </div>

                <div class="metrics-display" id="metricsDisplay" style="display: none;">
                    <div><strong>Customer Receptiveness:</strong></div>
                    <div class="receptiveness-bar-container">
                        <div class="receptiveness-bar" id="receptivenessBar"></div>
                    </div>
                    <span id="receptivenessText">50%</span>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div><strong>Good Moves:</strong> <span id="goodMovesCount">0</span></div>
                        <div><strong>Bad Moves:</strong> <span id="badMovesCount">0</span></div>
                        <div><strong>Exchanges:</strong> <span id="exchangesCount">0</span></div>
                    </div>
                </div>

                <div class="status waiting" id="status">Ready to Start</div>

                <div class="controls">
                    <button class="btn btn-primary" id="startBtn" onclick="startTraining()">‚ñ∂Ô∏è Start Training</button>
                    <button class="btn btn-primary" id="endBtn" onclick="endCall()" disabled style="background: #f56565;">‚èπÔ∏è End Call</button>
                </div>

                <div class="input-area">
                    <textarea id="agentInput" placeholder="Type your response here..." disabled></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" id="voiceBtn" onclick="toggleVoice()" disabled style="flex: 1; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            üé§ Push to Talk
                        </button>
                        <button class="btn btn-primary" id="sendBtn" onclick="sendResponse()" style="flex: 2;" disabled>üì§ Send Response</button>
                    </div>
                </div>

                <div class="conversation" id="conversation">
                    <p style="color: #a0aec0; text-align: center;">Conversation will appear here...</p>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-export" id="downloadTranscriptBtn" onclick="downloadTranscript()" disabled style="flex: 1;">
                        üì• Download Transcript
                    </button>
                    <button class="btn btn-export" id="downloadFeedbackBtn" onclick="downloadFeedback()" disabled style="flex: 1;">
                        üì• Download Feedback
                    </button>
                </div>

                <div class="card" id="feedbackCard" style="display: none; margin-top: 20px;">
                    <h3>Performance Feedback</h3>
                    <div id="sessionFeedback"></div>
                </div>
            </div>

            <div id="history" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>My Training History</h2>
                    <button class="btn btn-export" onclick="exportMyData()">üì• Export My Data to Excel</button>
                </div>
                <div class="history-list" id="historyList">
                    <p style="color: #a0aec0; text-align: center;">No training sessions yet.</p>
                </div>
            </div>

            <div id="insights" class="tab-content">
                <h2>Personal Insights & Progress</h2>
                
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                    <p style="color: #718096;">Progress chart will appear after 3+ sessions</p>
                </div>

                <div class="insights-grid" id="insightsGrid">
                    <div class="insight-card">
                        <h4>üí™ Your Strengths</h4>
                        <p id="strengths">Complete more sessions to see patterns...</p>
                    </div>
                    <div class="insight-card">
                        <h4>üéØ Focus Areas</h4>
                        <p id="focusAreas">Complete more sessions to see patterns...</p>
                    </div>
                    <div class="insight-card">
                        <h4>üìà Progress Trend</h4>
                        <p id="progressTrend">Complete more sessions to see trends...</p>
                    </div>
                    <div class="insight-card">
                        <h4>üèÖ Recommended Next</h4>
                        <p id="recommended">Try different scenario types for balanced training</p>
                    </div>
                    <div class="insight-card">
                        <h4>‚ö° Training Velocity</h4>
                        <p id="velocity">-</p>
                    </div>
                    <div class="insight-card">
                        <h4>üéì Skill Level</h4>
                        <p id="skillLevel">Beginner</p>
                    </div>
                </div>
            </div>

            <div id="leaderboard" class="tab-content">
                <h2>Team Leaderboard</h2>
                <p style="margin-bottom: 20px; color: #4a5568;">Top performers based on average scores across all sessions</p>
                <div class="leaderboard" id="leaderboardList">
                    <p style="color: #a0aec0; text-align: center;">No data yet.</p>
                </div>
            </div>

            <div id="upload" class="tab-content">
                <h2>Upload Real Customer Calls</h2>
                <div class="alert-box info">
                    <strong>üí° How it works:</strong> Upload recordings of actual customer cancellation calls. The system will analyze them and create custom training scenarios based on real situations your team faces.
                </div>

                <div class="upload-zone" id="uploadZone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
                    <h3>üìÅ Drop audio files here or click to browse</h3>
                    <p>Supported formats: MP3, WAV, M4A</p>
                    <input type="file" id="fileInput" accept=".mp3,.wav,.m4a" style="display: none;" multiple onchange="handleFiles(this.files)">
                </div>

                <div class="call-list" id="callList">
                    <!-- Uploaded calls will appear here -->
                </div>
            </div>

            <div id="teamanalytics" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>Team Analytics Dashboard</h2>
                    <button class="btn btn-export" onclick="exportTeamData()">üì• Export Team Report to Excel</button>
                </div>

                <div class="team-metrics">
                    <div class="metric-card">
                        <div class="value" id="teamTotalSessions">0</div>
                        <div class="label">Total Sessions</div>
                    </div>
                    <div class="metric-card">
                        <div class="value" id="teamAvgScore">0%</div>
                        <div class="label">Team Avg Score</div>
                    </div>
                    <div class="metric-card">
                        <div class="value" id="teamActiveAgents">0</div>
                        <div class="label">Active Agents</div>
                    </div>
                    <div class="metric-card">
                        <div class="value" id="teamImprovement">-</div>
                        <div class="label">Team Improvement</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Team Performance Trends</h3>
                    <div class="chart-container">
                        <p style="color: #718096;">Team performance chart</p>
                    </div>
                </div>

                <div class="card">
                    <h3>üéØ Scenario Performance Breakdown</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>Moving Scenarios</h4>
                            <p id="movingPerf">Avg: -</p>
                        </div>
                        <div class="insight-card">
                            <h4>Financial Scenarios</h4>
                            <p id="financialPerf">Avg: -</p>
                        </div>
                        <div class="insight-card">
                            <h4>Bad Service Scenarios</h4>
                            <p id="badServicePerf">Avg: -</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚ö†Ô∏è Agents Needing Support</h3>
                    <div id="needsSupport">
                        <p style="color: #a0aec0;">All agents are performing well!</p>
                    </div>
                </div>
            </div>

            <div id="managerdash" class="tab-content">
                <h2>Manager Dashboard</h2>
                
                <div class="alert-box warning">
                    <strong>üéØ Action Items:</strong> <span id="actionItems">Review agents with declining scores</span>
                </div>

                <div class="card">
                    <h3>üë• Agent Performance Overview</h3>
                    <table class="agent-table" id="agentTable">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>Sessions</th>
                                <th>Avg Score</th>
                                <th>Improvement</th>
                                <th>Last Active</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="agentTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #a0aec0;">No agent data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <h3>üéì Training Recommendations</h3>
                    <div id="trainingRecs">
                        <p>‚Ä¢ Schedule weekly team training sessions</p>
                        <p>‚Ä¢ Focus on bad service scenarios (lowest team score)</p>
                        <p>‚Ä¢ Recognize top performers in team meeting</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Scenario definitions with difficulty levels and full conversation data
        const SCENARIOS = {
            moving: [
                {
                    name: "Moving Out of State",
                    difficulty: "easy",
                    baseScore: 70,
                    opening: "Hi, I need to cancel my lawn service. I'm moving to Arizona next month for a new job.",
                    concern: "moving"
                },
                {
                    name: "Moving Within Service Area",
                    difficulty: "easy",
                    baseScore: 80,
                    opening: "Hi, I'm calling about my lawn service. I'm moving to a new house about 8 miles from here and wanted to see about transferring my service.",
                    concern: "moving"
                }
            ],
            financial: {
                name: "Budget Concerns - Lost Job",
                difficulty: "medium",
                baseScore: 60,
                opening: "Hi, I'm calling to cancel my service. I lost my job last month and need to cut all my expenses.",
                concern: "financial"
            },
            bad_service: {
                name: "Missed Appointments",
                difficulty: "hard",
                baseScore: 40,
                opening: "I'm calling to cancel. Your tech has missed the last three appointments and I'm fed up with this.",
                concern: "service quality"
            },
            not_working: {
                name: "Treatment Not Working - Weeds",
                difficulty: "medium",
                baseScore: 55,
                opening: "I need to cancel. I've been paying you for six months and my lawn still has weeds everywhere. This isn't working.",
                concern: "results"
            },
            competitor: {
                name: "Cheaper Competitor",
                difficulty: "medium",
                baseScore: 65,
                opening: "I got a quote from TruGreen that's $40 a month cheaper than you guys. I think I'm going to switch.",
                concern: "price"
            }
        };

        let currentUser = '';
        let currentRole = 'agent';
        let currentSession = null;
        let uploadedCalls = [];
        let recognition = null;
        let isListening = false;
        let voiceEnabled = true;

        // Initialize speech recognition
        window.onload = function() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    console.log('üé§ Speech recognition started');
                    isListening = true;
                    document.getElementById('voiceBtn').textContent = 'üõë Recording... Click to Stop';
                    document.getElementById('voiceBtn').style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    updateStatus('üé§ Listening... Speak now', 'speaking');
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    const confidence = event.results[0][0].confidence;
                    console.log('‚úÖ Recognized:', transcript, '(Confidence:', confidence, ')');
                    document.getElementById('agentInput').value = transcript;
                    isListening = false;
                    document.getElementById('voiceBtn').textContent = 'üé§ Push to Talk';
                    document.getElementById('voiceBtn').style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                    updateStatus('‚úÖ Got it! Review and click Send', 'waiting');
                };

                recognition.onerror = function(event) {
                    console.error('‚ùå Speech recognition error:', event.error);
                    isListening = false;
                    document.getElementById('voiceBtn').textContent = 'üé§ Push to Talk';
                    document.getElementById('voiceBtn').style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                    
                    if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                        alert('üö´ Microphone Access Denied\n\nTo use voice input:\n1. Click the üîí or üõ°Ô∏è icon in your browser address bar\n2. Allow microphone access\n3. Refresh the page\n4. Try again');
                        updateStatus('Microphone permission denied - check browser settings', 'waiting');
                    } else if (event.error === 'no-speech') {
                        updateStatus('‚ö†Ô∏è No speech detected - try speaking louder or closer to mic', 'waiting');
                    } else if (event.error === 'audio-capture') {
                        alert('üé§ No Microphone Detected\n\nMake sure:\n‚Ä¢ A microphone is connected\n‚Ä¢ It\'s not being used by another app\n‚Ä¢ It\'s selected as the default device');
                        updateStatus('No microphone found - check your device', 'waiting');
                    } else if (event.error === 'network') {
                        updateStatus('‚ö†Ô∏è Network error - check your internet connection', 'waiting');
                    } else {
                        updateStatus('‚ö†Ô∏è Voice recognition error: ' + event.error, 'waiting');
                    }
                };

                recognition.onend = function() {
                    console.log('üî¥ Speech recognition ended');
                    isListening = false;
                    document.getElementById('voiceBtn').textContent = 'üé§ Push to Talk';
                    document.getElementById('voiceBtn').style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                };

                // Test microphone permissions on load
                checkMicrophonePermission();
            } else {
                console.warn('‚ö†Ô∏è Speech recognition not supported');
                document.getElementById('voiceBtn').innerHTML = '‚ö†Ô∏è Voice Not Supported';
                document.getElementById('voiceBtn').title = 'Speech recognition requires Chrome, Edge, or Safari';
                document.getElementById('voiceBtn').style.background = '#94a3b8';
            }
        };

        async function checkMicrophonePermission() {
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    console.log('üé§ Microphone permission:', result.state);
                    
                    if (result.state === 'denied') {
                        console.warn('‚ö†Ô∏è Microphone access is denied');
                    }
                    
                    result.onchange = function() {
                        console.log('üé§ Microphone permission changed to:', this.state);
                    };
                }
            } catch (error) {
                console.log('Could not check microphone permission:', error);
            }
        }

        function toggleVoice() {
            if (!recognition) {
                alert('Voice input is not supported in your browser.\n\nSupported browsers:\n‚Ä¢ Chrome\n‚Ä¢ Edge\n‚Ä¢ Safari\n\nPlease use one of these browsers to use voice input.');
                return;
            }

            if (isListening) {
                console.log('Stopping recognition...');
                recognition.stop();
            } else {
                console.log('Starting recognition...');
                try {
                    document.getElementById('agentInput').value = ''; // Clear previous text
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    if (error.name === 'InvalidStateError') {
                        // Recognition is already running, stop it first
                        recognition.stop();
                        setTimeout(() => {
                            recognition.start();
                        }, 100);
                    } else {
                        alert('Could not start voice input.\n\nTroubleshooting:\n1. Make sure your microphone is connected\n2. Check browser permissions (click üîí in address bar)\n3. Close other apps using the microphone\n4. Refresh the page and try again');
                    }
                }
            }
        }

        function speakText(text) {
            if (!voiceEnabled || !('speechSynthesis' in window)) {
                return;
            }

            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Try to use a natural voice
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.name.includes('Google') || 
                voice.name.includes('Natural') ||
                voice.name.includes('Samantha') ||
                voice.name.includes('Alex')
            );
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }

            window.speechSynthesis.speak(utterance);
        }


        function setRole(role) {
            currentRole = role;
            document.getElementById('roleAgent').classList.toggle('active', role === 'agent');
            document.getElementById('roleManager').classList.toggle('active', role === 'manager');
            
            const showManager = role === 'manager';
            document.getElementById('tabTeamAnalytics').style.display = showManager ? 'block' : 'none';
            document.getElementById('tabManagerDash').style.display = showManager ? 'block' : 'none';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'history') loadHistory();
            if (tabName === 'insights') loadInsights();
            if (tabName === 'leaderboard') loadLeaderboard();
            if (tabName === 'teamanalytics') loadTeamAnalytics();
            if (tabName === 'managerdash') loadManagerDashboard();
        }

        function loadUserData() {
            currentUser = document.getElementById('agentName').value.trim();
            if (!currentUser) {
                alert('Please enter your name');
                return;
            }

            const userData = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = userData[currentUser] || {
                sessions: [],
                totalSessions: 0,
                avgScore: 0,
                bestScenario: '-',
                improvement: 0,
                level: 'Beginner'
            };

            document.getElementById('totalSessions').textContent = user.totalSessions;
            document.getElementById('avgScore').textContent = user.avgScore + '%';
            document.getElementById('bestScenario').textContent = user.bestScenario;
            document.getElementById('improvement').textContent = user.improvement > 0 ? '+' + user.improvement + '%' : user.improvement + '%';
            document.getElementById('currentLevel').textContent = user.level || 'Beginner';

            updateStatus('Welcome back, ' + currentUser + '!', 'waiting');
            updateAdaptiveRecommendation();
        }

        function updateAdaptiveRecommendation() {
            const userData = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = userData[currentUser];
            
            if (!user || user.sessions.length < 3) {
                document.getElementById('adaptiveNotice').style.display = 'none';
                return;
            }

            // Calculate which scenarios user struggles with
            const scenarioScores = {};
            user.sessions.forEach(s => {
                if (!scenarioScores[s.scenario]) scenarioScores[s.scenario] = [];
                scenarioScores[s.scenario].push(s.score);
            });

            const avgScores = {};
            Object.keys(scenarioScores).forEach(scenario => {
                const scores = scenarioScores[scenario];
                avgScores[scenario] = scores.reduce((a, b) => a + b, 0) / scores.length;
            });

            const weakestScenario = Object.keys(avgScores).reduce((a, b) => 
                avgScores[a] < avgScores[b] ? a : b
            );

            document.getElementById('adaptiveNotice').style.display = 'block';
            document.getElementById('adaptiveMessage').textContent = 
                `Based on your history, we recommend practicing "${SCENARIOS[weakestScenario].name}" scenarios. Select "Auto-Select" to use adaptive training.`;
        }

        function updateScenarioInfo() {
            const scenario = document.getElementById('scenario').value;
            if (scenario === 'auto') {
                document.getElementById('scenarioInfo').innerHTML = `
                    <h3>ü§ñ Auto-Select Mode</h3>
                    <p>The system will choose the best scenario for your training based on your performance history.</p>
                `;
            }
        }

        function selectAdaptiveScenario() {
            const userData = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = userData[currentUser];
            
            if (!user || user.sessions.length < 3) {
                // Not enough data, select randomly
                const scenarios = Object.keys(SCENARIOS);
                return scenarios[Math.floor(Math.random() * scenarios.length)];
            }

            // Find weakest scenario
            const scenarioScores = {};
            user.sessions.forEach(s => {
                if (!scenarioScores[s.scenario]) scenarioScores[s.scenario] = [];
                scenarioScores[s.scenario].push(s.score);
            });

            const avgScores = {};
            Object.keys(scenarioScores).forEach(scenario => {
                const scores = scenarioScores[scenario];
                avgScores[scenario] = scores.reduce((a, b) => a + b, 0) / scores.length;
            });

            return Object.keys(avgScores).reduce((a, b) => 
                avgScores[a] < avgScores[b] ? a : b
            );
        }

        function startTraining() {
            if (!currentUser) {
                alert('Please enter your name first');
                return;
            }

            let scenarioKey = document.getElementById('scenario').value;
            if (scenarioKey === 'auto') {
                scenarioKey = selectAdaptiveScenario();
            }

            // Handle scenarios that are arrays (like moving)
            let scenarioData = SCENARIOS[scenarioKey];
            if (Array.isArray(scenarioData)) {
                scenarioData = scenarioData[Math.floor(Math.random() * scenarioData.length)];
            }

            currentSession = {
                user: currentUser,
                scenario: scenarioKey,
                scenarioName: scenarioData.name,
                startTime: new Date().toISOString(),
                conversation: [],
                score: 0,
                goodMoves: 0,
                badMoves: 0,
                opening: scenarioData.opening
            };

            document.getElementById('startBtn').disabled = true;
            document.getElementById('endBtn').disabled = false;
            document.getElementById('agentInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('voiceBtn').disabled = false;
            document.getElementById('metricsDisplay').style.display = 'block';

            const difficulty = scenarioData.difficulty;
            const difficultyBadge = `<span class="difficulty-badge ${difficulty}">${difficulty.toUpperCase()}</span>`;

            document.getElementById('scenarioInfo').innerHTML = `
                <h3>${scenarioData.name} ${difficultyBadge}</h3>
                <p><strong>Customer Concern:</strong> ${scenarioData.concern}</p>
                <p>Listen carefully to their reason and practice your retention skills!</p>
            `;

            const opening = scenarioData.opening;
            document.getElementById('conversation').innerHTML = `<div class="message customer"><strong>üë§ Customer</strong>${opening}</div>`;
            currentSession.conversation.push({ role: 'customer', content: opening });

            // Speak the opening
            setTimeout(() => {
                speakText(opening);
            }, 500);

            updateStatus('Your turn - Type or speak your response', 'waiting');
        }

        function sendResponse() {
            const input = document.getElementById('agentInput');
            const response = input.value.trim();

            if (!response) {
                alert('Please type a response first');
                return;
            }

            currentSession.conversation.push({ role: 'agent', content: response });
            
            const conversationEl = document.getElementById('conversation');
            conversationEl.innerHTML += `<div class="message agent"><strong>üéß You</strong>${response}</div>`;
            conversationEl.scrollTop = conversationEl.scrollHeight;
            
            input.value = '';

            // Analyze response quality
            const hasEmpathy = /understand|sorry|appreciate|thank/i.test(response);
            const hasSolution = /offer|can|help|would|option|plan/i.test(response);
            const isPushy = /must|should|need to|have to/i.test(response);

            if (hasEmpathy) currentSession.goodMoves++;
            if (hasSolution) currentSession.goodMoves++;
            if (isPushy) currentSession.badMoves++;

            // Simulate customer response
            setTimeout(() => {
                const customerResponse = hasEmpathy && hasSolution ? 
                    "That's helpful, thank you. Let me think about those options." :
                    isPushy ? 
                    "I appreciate your time, but I've made up my mind." :
                    "I understand, but I still need to cancel.";
                
                currentSession.conversation.push({ role: 'customer', content: customerResponse });
                conversationEl.innerHTML += `<div class="message customer"><strong>üë§ Customer</strong>${customerResponse}</div>`;
                conversationEl.scrollTop = conversationEl.scrollHeight;

                // Speak customer response
                speakText(customerResponse);

                // Update metrics
                const exchanges = Math.floor(currentSession.conversation.length / 2);
                document.getElementById('exchangesCount').textContent = exchanges;
                document.getElementById('goodMovesCount').textContent = currentSession.goodMoves;
                document.getElementById('badMovesCount').textContent = currentSession.badMoves;
                
                // Get base score from the scenario
                let scenarioData = SCENARIOS[currentSession.scenario];
                if (Array.isArray(scenarioData)) {
                    scenarioData = scenarioData[0]; // Use first as default for scoring
                }
                const baseScore = scenarioData.baseScore;
                const score = Math.min(100, Math.max(0, baseScore + (currentSession.goodMoves * 10) - (currentSession.badMoves * 15)));
                document.getElementById('receptivenessBar').style.width = score + '%';
                document.getElementById('receptivenessText').textContent = score + '%';
                currentSession.score = score;
            }, 1500);
        }

        function endCall() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('endBtn').disabled = true;
            document.getElementById('agentInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('voiceBtn').disabled = true;
            document.getElementById('downloadTranscriptBtn').disabled = false;
            document.getElementById('downloadFeedbackBtn').disabled = false;

            // Stop any ongoing speech
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            if (recognition && isListening) {
                recognition.stop();
            }

            currentSession.endTime = new Date().toISOString();
            
            // Generate and display feedback
            generateFeedback();
            
            saveSession(currentSession);
            updateStatus('Session complete! Download your transcript and feedback below.', 'waiting');
            
            loadUserData();
        }

        function generateFeedback() {
            const score = currentSession.score;
            const goodMoves = currentSession.goodMoves;
            const badMoves = currentSession.badMoves;
            const exchanges = Math.floor(currentSession.conversation.length / 2);

            let rating, saveLikelihood, strengths, improvements;

            if (score >= 80) {
                rating = "Excellent";
                saveLikelihood = "85-95%";
                strengths = "Strong empathy and solution-focused approach. Great job acknowledging the customer's situation and offering specific alternatives.";
                improvements = "Continue this level of performance. Consider mentoring newer team members.";
            } else if (score >= 65) {
                rating = "Good";
                saveLikelihood = "60-75%";
                strengths = "Demonstrated empathy and offered solutions. Good conversational flow.";
                improvements = "Work on being more specific with solutions. Use concrete numbers and timelines when making offers.";
            } else if (score >= 50) {
                rating = "Adequate";
                saveLikelihood = "40-55%";
                strengths = "Made an effort to engage with the customer.";
                improvements = "Focus on showing more empathy before jumping to solutions. Listen actively and acknowledge their concerns more thoroughly.";
            } else {
                rating = "Needs Improvement";
                saveLikelihood = "20-35%";
                strengths = "Attempted to address the cancellation.";
                improvements = "Avoid pushy language. Focus on understanding the customer's situation first. Offer flexible solutions rather than trying to convince them they're wrong.";
            }

            const feedbackHTML = `
                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #2d5016; margin-bottom: 10px;">Overall Rating: ${rating}</h4>
                    <div style="margin-bottom: 15px;">
                        <strong>Customer Retention Likelihood:</strong> ${saveLikelihood}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Session Stats:</strong><br>
                        ‚Ä¢ Score: ${score}%<br>
                        ‚Ä¢ Good Moves: ${goodMoves}<br>
                        ‚Ä¢ Bad Moves: ${badMoves}<br>
                        ‚Ä¢ Total Exchanges: ${exchanges}
                    </div>
                </div>
                <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                    <h4 style="color: #065f46; margin-bottom: 10px;">üí™ Strengths</h4>
                    <p style="margin: 0; color: #065f46;">${strengths}</p>
                </div>
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: #92400e; margin-bottom: 10px;">üéØ Areas for Improvement</h4>
                    <p style="margin: 0; color: #92400e;">${improvements}</p>
                </div>
            `;

            document.getElementById('sessionFeedback').innerHTML = feedbackHTML;
            document.getElementById('feedbackCard').style.display = 'block';
        }

        function downloadTranscript() {
            if (!currentSession) return;

            let content = "SPRING TOUCH TRAINING - CONVERSATION TRANSCRIPT\n";
            content += "=".repeat(60) + "\n\n";
            content += `Agent: ${currentUser}\n`;
            content += `Date: ${new Date(currentSession.startTime).toLocaleString()}\n`;
            content += `Scenario: ${currentSession.scenarioName || 'Training Session'}\n`;
            content += `Final Score: ${currentSession.score}%\n`;
            content += "\n" + "=".repeat(60) + "\n\n";
            content += "CONVERSATION:\n\n";

            currentSession.conversation.forEach((msg, index) => {
                const speaker = msg.role === 'customer' ? 'CUSTOMER' : 'AGENT';
                content += `${speaker}: ${msg.content}\n\n`;
            });

            content += "=".repeat(60) + "\n";
            content += `\nPerformance Metrics:\n`;
            content += `- Good Moves: ${currentSession.goodMoves}\n`;
            content += `- Bad Moves: ${currentSession.badMoves}\n`;
            content += `- Total Exchanges: ${Math.floor(currentSession.conversation.length / 2)}\n`;

            downloadFile(`Spring_Touch_Transcript_${new Date().toISOString().split('T')[0]}.txt`, content);
        }

        function downloadFeedback() {
            if (!currentSession) return;

            const score = currentSession.score;
            let rating, saveLikelihood, strengths, improvements;

            if (score >= 80) {
                rating = "Excellent";
                saveLikelihood = "85-95%";
                strengths = "Strong empathy and solution-focused approach. Great job acknowledging the customer's situation and offering specific alternatives.";
                improvements = "Continue this level of performance. Consider mentoring newer team members.";
            } else if (score >= 65) {
                rating = "Good";
                saveLikelihood = "60-75%";
                strengths = "Demonstrated empathy and offered solutions. Good conversational flow.";
                improvements = "Work on being more specific with solutions. Use concrete numbers and timelines when making offers.";
            } else if (score >= 50) {
                rating = "Adequate";
                saveLikelihood = "40-55%";
                strengths = "Made an effort to engage with the customer.";
                improvements = "Focus on showing more empathy before jumping to solutions. Listen actively and acknowledge their concerns more thoroughly.";
            } else {
                rating = "Needs Improvement";
                saveLikelihood = "20-35%";
                strengths = "Attempted to address the cancellation.";
                improvements = "Avoid pushy language. Focus on understanding the customer's situation first. Offer flexible solutions rather than trying to convince them they're wrong.";
            }

            let content = "SPRING TOUCH TRAINING - PERFORMANCE FEEDBACK\n";
            content += "=".repeat(60) + "\n\n";
            content += `Agent: ${currentUser}\n`;
            content += `Date: ${new Date(currentSession.startTime).toLocaleString()}\n`;
            content += `Scenario: ${currentSession.scenarioName || 'Training Session'}\n\n`;
            content += "=".repeat(60) + "\n\n";
            content += `OVERALL RATING: ${rating}\n\n`;
            content += `Customer Retention Likelihood: ${saveLikelihood}\n\n`;
            content += `SESSION STATISTICS:\n`;
            content += `- Final Score: ${score}%\n`;
            content += `- Good Moves: ${currentSession.goodMoves}\n`;
            content += `- Bad Moves: ${currentSession.badMoves}\n`;
            content += `- Total Exchanges: ${Math.floor(currentSession.conversation.length / 2)}\n\n`;
            content += "=".repeat(60) + "\n\n";
            content += `STRENGTHS:\n${strengths}\n\n`;
            content += `AREAS FOR IMPROVEMENT:\n${improvements}\n\n`;
            content += "=".repeat(60) + "\n\n";
            content += `NEXT STEPS:\n`;
            content += `- Review this feedback with your supervisor\n`;
            content += `- Practice scenarios where you scored below 70%\n`;
            content += `- Focus on the improvement areas mentioned above\n`;
            content += `- Complete 2-3 training sessions per week for best results\n`;

            downloadFile(`Spring_Touch_Feedback_${new Date().toISOString().split('T')[0]}.txt`, content);
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function saveSession(session) {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            
            if (!users[currentUser]) {
                users[currentUser] = {
                    sessions: [],
                    totalSessions: 0,
                    avgScore: 0,
                    bestScenario: '-',
                    improvement: 0,
                    level: 'Beginner'
                };
            }

            users[currentUser].sessions.push(session);
            users[currentUser].totalSessions++;
            
            const scores = users[currentUser].sessions.map(s => s.score);
            users[currentUser].avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            
            const scenarioCounts = {};
            users[currentUser].sessions.forEach(s => {
                scenarioCounts[s.scenario] = (scenarioCounts[s.scenario] || 0) + 1;
            });
            users[currentUser].bestScenario = Object.keys(scenarioCounts).reduce((a, b) => 
                scenarioCounts[a] > scenarioCounts[b] ? a : b
            );

            if (scores.length >= 2) {
                const recent = scores.slice(-3).reduce((a, b) => a + b, 0) / Math.min(3, scores.length);
                const earlier = scores.slice(0, -3).reduce((a, b) => a + b, 0) / Math.max(1, scores.length - 3);
                users[currentUser].improvement = Math.round(recent - earlier);
            }

            // Calculate level
            const avgScore = users[currentUser].avgScore;
            const totalSessions = users[currentUser].totalSessions;
            users[currentUser].level = 
                avgScore >= 80 && totalSessions >= 10 ? 'Expert' :
                avgScore >= 70 && totalSessions >= 5 ? 'Advanced' :
                avgScore >= 60 && totalSessions >= 3 ? 'Intermediate' :
                'Beginner';

            localStorage.setItem('springtouch_users', JSON.stringify(users));
        }

        function loadHistory() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (!user || user.sessions.length === 0) {
                document.getElementById('historyList').innerHTML = '<p style="color: #a0aec0; text-align: center;">No training sessions yet.</p>';
                return;
            }

            let html = '';
            [...user.sessions].reverse().forEach((session, index) => {
                const date = new Date(session.startTime).toLocaleString();
                
                // Get scenario data (handle arrays)
                let scenarioData = SCENARIOS[session.scenario];
                if (Array.isArray(scenarioData)) {
                    scenarioData = scenarioData[0];
                }
                
                const scenarioName = session.scenarioName || scenarioData.name;
                const difficulty = scenarioData.difficulty;
                
                html += `
                    <div class="history-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${scenarioName}</strong>
                                <span class="difficulty-badge ${difficulty}">${difficulty}</span>
                                <div class="date">${date}</div>
                                <div style="color: #4a5568; font-size: 0.9em; margin-top: 5px;">
                                    ${session.goodMoves || 0} good moves, ${session.badMoves || 0} bad moves
                                </div>
                            </div>
                            <div class="score">${session.score}%</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('historyList').innerHTML = html;
        }

        function loadInsights() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (!user || user.sessions.length < 3) {
                return;
            }

            const scores = user.sessions.map(s => s.score);
            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;

            document.getElementById('strengths').textContent = 
                avgScore > 75 ? 'Excellent retention skills overall! Strong empathy and solution offering.' :
                avgScore > 60 ? 'Good empathy and problem-solving. Consistent performance.' :
                'Building foundation skills. Keep practicing!';

            document.getElementById('focusAreas').textContent = 
                avgScore < 60 ? 'Work on empathy statements and offering specific solutions' :
                avgScore < 75 ? 'Try more difficult scenarios to challenge yourself' :
                'Maintain consistency. Consider mentoring newer agents.';

            const trend = scores.slice(-3).reduce((a, b) => a + b) / 3 - scores.slice(0, 3).reduce((a, b) => a + b) / 3;
            document.getElementById('progressTrend').textContent = 
                trend > 10 ? 'üìà Improving significantly! Up ' + Math.round(trend) + '% from early sessions' :
                trend > 0 ? '‚û°Ô∏è Steady improvement. Up ' + Math.round(trend) + '%' :
                trend > -5 ? 'üìä Maintaining performance' :
                'üìâ Slight decline. Consider refresher training.';

            document.getElementById('recommended').textContent = 
                'Try ' + (user.bestScenario === 'financial' ? 'bad_service' : 'financial') + ' scenarios to broaden skills';

            // Training velocity
            const lastSession = new Date(user.sessions[user.sessions.length - 1].startTime);
            const firstSession = new Date(user.sessions[0].startTime);
            const daysBetween = Math.floor((lastSession - firstSession) / (1000 * 60 * 60 * 24)) || 1;
            const sessionsPerWeek = (user.sessions.length / daysBetween * 7).toFixed(1);
            document.getElementById('velocity').textContent = sessionsPerWeek + ' sessions/week';

            document.getElementById('skillLevel').textContent = user.level;
        }

        function loadLeaderboard() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const leaderboard = Object.keys(users)
                .map(name => ({
                    name: name,
                    avgScore: users[name].avgScore,
                    sessions: users[name].totalSessions,
                    level: users[name].level
                }))
                .sort((a, b) => b.avgScore - a.avgScore)
                .slice(0, 10);

            if (leaderboard.length === 0) {
                document.getElementById('leaderboardList').innerHTML = '<p style="color: #a0aec0; text-align: center;">No data yet.</p>';
                return;
            }

            let html = '';
            leaderboard.forEach((user, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                html += `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">${medal || (index + 1)}</div>
                        <div class="leaderboard-name">
                            ${user.name}
                            <div style="font-size: 0.8em; color: #718096;">${user.level}</div>
                        </div>
                        <div class="leaderboard-score">${user.avgScore}%</div>
                        <div style="color: #718096; font-size: 0.9em;">${user.sessions} sessions</div>
                    </div>
                `;
            });

            document.getElementById('leaderboardList').innerHTML = html;
        }

        function loadTeamAnalytics() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const allUsers = Object.values(users);
            
            if (allUsers.length === 0) {
                return;
            }

            const totalSessions = allUsers.reduce((sum, u) => sum + u.totalSessions, 0);
            const avgScore = Math.round(allUsers.reduce((sum, u) => sum + u.avgScore, 0) / allUsers.length);
            const activeAgents = allUsers.filter(u => u.totalSessions > 0).length;
            
            const allScores = allUsers.flatMap(u => u.sessions.map(s => s.score));
            const recentScores = allScores.slice(-20);
            const earlierScores = allScores.slice(0, -20);
            const improvement = recentScores.length > 0 && earlierScores.length > 0 ?
                Math.round(recentScores.reduce((a, b) => a + b) / recentScores.length - 
                           earlierScores.reduce((a, b) => a + b) / earlierScores.length) : 0;

            document.getElementById('teamTotalSessions').textContent = totalSessions;
            document.getElementById('teamAvgScore').textContent = avgScore + '%';
            document.getElementById('teamActiveAgents').textContent = activeAgents;
            document.getElementById('teamImprovement').textContent = improvement > 0 ? '+' + improvement + '%' : improvement + '%';

            // Scenario performance
            const scenarioScores = {};
            allUsers.forEach(user => {
                user.sessions.forEach(session => {
                    if (!scenarioScores[session.scenario]) scenarioScores[session.scenario] = [];
                    scenarioScores[session.scenario].push(session.score);
                });
            });

            Object.keys(scenarioScores).forEach(scenario => {
                const scores = scenarioScores[scenario];
                const avg = Math.round(scores.reduce((a, b) => a + b) / scores.length);
                const elementId = scenario + 'Perf';
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = `Avg: ${avg}% (${scores.length} attempts)`;
                }
            });

            // Agents needing support
            const needsSupport = allUsers.filter(u => u.avgScore < 60 || u.improvement < -5);
            if (needsSupport.length > 0) {
                let html = '<ul>';
                needsSupport.forEach(user => {
                    html += `<li><strong>${user.name}</strong> - Avg: ${user.avgScore}%, Trend: ${user.improvement}%</li>`;
                });
                html += '</ul>';
                document.getElementById('needsSupport').innerHTML = html;
            }
        }

        function loadManagerDashboard() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const allUsers = Object.entries(users).map(([name, data]) => ({
                name,
                ...data
            }));

            if (allUsers.length === 0) {
                return;
            }

            let tableHtml = '';
            allUsers.forEach(user => {
                const lastSession = user.sessions.length > 0 ? 
                    new Date(user.sessions[user.sessions.length - 1].startTime).toLocaleDateString() : 
                    'Never';
                
                const status = user.improvement > 5 ? '‚úÖ Improving' :
                               user.improvement < -5 ? '‚ö†Ô∏è Declining' :
                               user.avgScore > 70 ? '‚úì Good' : '‚ö†Ô∏è Needs Support';

                const statusColor = user.improvement > 5 ? '#10b981' :
                                   user.improvement < -5 ? '#f59e0b' :
                                   user.avgScore > 70 ? '#4a7c2c' : '#ef4444';

                tableHtml += `
                    <tr>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.totalSessions}</td>
                        <td>
                            ${user.avgScore}%
                            <div class="progress-bar" style="margin-top: 5px;">
                                <div class="progress-fill" style="width: ${user.avgScore}%"></div>
                            </div>
                        </td>
                        <td style="color: ${user.improvement > 0 ? '#10b981' : '#ef4444'}">
                            ${user.improvement > 0 ? '+' : ''}${user.improvement}%
                        </td>
                        <td>${lastSession}</td>
                        <td style="color: ${statusColor}; font-weight: 600;">${status}</td>
                    </tr>
                `;
            });

            document.getElementById('agentTableBody').innerHTML = tableHtml;

            // Action items
            const declining = allUsers.filter(u => u.improvement < -5).length;
            const needsTraining = allUsers.filter(u => u.avgScore < 60).length;
            const inactive = allUsers.filter(u => {
                if (u.sessions.length === 0) return true;
                const lastSession = new Date(u.sessions[u.sessions.length - 1].startTime);
                const daysSince = (Date.now() - lastSession) / (1000 * 60 * 60 * 24);
                return daysSince > 7;
            }).length;

            let actionItems = [];
            if (declining > 0) actionItems.push(`${declining} agent(s) showing declining performance`);
            if (needsTraining > 0) actionItems.push(`${needsTraining} agent(s) below 60% average`);
            if (inactive > 0) actionItems.push(`${inactive} agent(s) inactive for 7+ days`);

            document.getElementById('actionItems').textContent = 
                actionItems.length > 0 ? actionItems.join(' ‚Ä¢ ') : 'All agents performing well!';
        }

        function exportMyData() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (!user || user.sessions.length === 0) {
                alert('No data to export');
                return;
            }

            const data = user.sessions.map(session => ({
                'Date': new Date(session.startTime).toLocaleString(),
                'Scenario': SCENARIOS[session.scenario].name,
                'Difficulty': SCENARIOS[session.scenario].difficulty,
                'Score': session.score + '%',
                'Good Moves': session.goodMoves,
                'Bad Moves': session.badMoves,
                'Exchanges': Math.floor(session.conversation.length / 2)
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Training History');
            XLSX.writeFile(wb, `${currentUser}_Training_History_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportTeamData() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            
            const summary = Object.entries(users).map(([name, data]) => ({
                'Agent Name': name,
                'Total Sessions': data.totalSessions,
                'Average Score': data.avgScore + '%',
                'Best Scenario': data.bestScenario,
                'Improvement': data.improvement + '%',
                'Level': data.level || 'Beginner'
            }));

            const allSessions = [];
            Object.entries(users).forEach(([name, data]) => {
                data.sessions.forEach(session => {
                    allSessions.push({
                        'Agent': name,
                        'Date': new Date(session.startTime).toLocaleString(),
                        'Scenario': SCENARIOS[session.scenario].name,
                        'Score': session.score + '%',
                        'Good Moves': session.goodMoves,
                        'Bad Moves': session.badMoves
                    });
                });
            });

            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.json_to_sheet(summary);
            const ws2 = XLSX.utils.json_to_sheet(allSessions);
            XLSX.utils.book_append_sheet(wb, ws1, 'Team Summary');
            XLSX.utils.book_append_sheet(wb, ws2, 'All Sessions');
            XLSX.writeFile(wb, `Spring_Touch_Team_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            document.getElementById('uploadZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.match('audio.*')) {
                    const call = {
                        name: file.name,
                        size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                        uploadDate: new Date().toLocaleString(),
                        processed: false
                    };
                    
                    uploadedCalls.push(call);
                    displayUploadedCalls();
                }
            });
        }

        function displayUploadedCalls() {
            let html = '<h3 style="margin-top: 20px;">Uploaded Calls</h3>';
            uploadedCalls.forEach((call, index) => {
                html += `
                    <div class="call-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üé§ ${call.name}</strong>
                                <div style="color: #718096; font-size: 0.9em;">${call.size} ‚Ä¢ ${call.uploadDate}</div>
                            </div>
                            <div>
                                ${call.processed ? 
                                    '<span class="badge" style="background: #10b981;">‚úì Processed</span>' : 
                                    '<span class="badge" style="background: #f59e0b;">‚è≥ Processing...</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('callList').innerHTML = html;

            // Simulate processing
            setTimeout(() => {
                uploadedCalls.forEach(call => call.processed = true);
                displayUploadedCalls();
            }, 3000);
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
    </script>
</body>
</html>
