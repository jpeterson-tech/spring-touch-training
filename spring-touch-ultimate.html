<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Touch Training - Complete with Centralized Database</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2c 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2d5016;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px;
        }

        .badge.premium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .role-selector {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .role-btn {
            flex: 1;
            padding: 30px;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .role-btn:hover {
            border-color: #4a7c2c;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(74, 124, 44, 0.3);
        }

        .role-btn.active {
            border-color: #2d5016;
            background: #f0fdf4;
        }

        .role-btn h3 {
            color: #2d5016;
            margin-bottom: 10px;
        }

        .user-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 2fr 4fr;
            gap: 20px;
        }

        .user-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-input label {
            color: #2d5016;
            font-weight: 600;
        }

        .user-input input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #e6f7ed 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #4a7c2c;
        }

        .stat-box .label {
            color: #2d5016;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .stat-box .value {
            color: #2d5016;
            font-size: 1.8em;
            font-weight: 700;
        }

        .tabs {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .tab-buttons {
            display: flex;
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: white;
            color: #2d5016;
            border-bottom: 3px solid #4a7c2c;
        }

        .tab-button.manager-only {
            background: #fef3c7;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #2d5016;
            margin-bottom: 20px;
        }

        .scenario-selector {
            margin-bottom: 20px;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .difficulty-badge.easy {
            background: #c6f6d5;
            color: #22543d;
        }

        .difficulty-badge.medium {
            background: #feebc8;
            color: #7c2d12;
        }

        .difficulty-badge.hard {
            background: #fed7d7;
            color: #742a2a;
        }

        .scenario-selector label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .scenario-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .adaptive-notice {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f59e0b;
        }

        .scenario-info {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4a7c2c;
        }

        .metrics-display {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .receptiveness-bar-container {
            background: #e2e8f0;
            height: 20px;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .receptiveness-bar {
            background: linear-gradient(90deg, #f56565 0%, #ed8936 33%, #ecc94b 66%, #48bb78 100%);
            height: 100%;
            width: 50%;
            transition: width 0.5s;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .status.waiting {
            background: #bee3f8;
            color: #2c5282;
        }

        .status.speaking {
            background: #c6f6d5;
            color: #22543d;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a7c2c 0%, #2d5016 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 124, 44, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-area textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .conversation {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            line-height: 1.6;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.customer {
            background: #fff5f5;
            border-left: 4px solid #f56565;
        }

        .message.agent {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
        }

        .message strong {
            display: block;
            margin-bottom: 5px;
        }

        .upload-zone {
            border: 3px dashed #4a7c2c;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0fdf4;
        }

        .upload-zone:hover {
            background: #e6f7ed;
            border-color: #2d5016;
        }

        .upload-zone.dragover {
            background: #d1fae5;
            transform: scale(1.02);
        }

        .call-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .call-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4a7c2c;
        }

        .history-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .history-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4a7c2c;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: #e6f7ed;
            transform: translateX(5px);
        }

        .history-item .date {
            color: #718096;
            font-size: 0.9em;
        }

        .history-item .score {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d5016;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #4a7c2c;
        }

        .insight-card h4 {
            color: #2d5016;
            margin-bottom: 10px;
        }

        .chart-container {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .leaderboard {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .leaderboard-rank {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d5016;
            width: 40px;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
        }

        .leaderboard-score {
            font-size: 1.2em;
            font-weight: 700;
            color: #4a7c2c;
        }

        .team-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #e6f7ed 100%);
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #4a7c2c;
            text-align: center;
        }

        .metric-card .value {
            font-size: 3em;
            font-weight: 700;
            color: #2d5016;
            margin-bottom: 10px;
        }

        .metric-card .label {
            color: #4a5568;
            font-weight: 600;
        }

        .agent-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .agent-table th {
            background: #2d5016;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .agent-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .agent-table tr:hover {
            background: #f0fdf4;
        }

        .progress-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a7c2c 0%, #2d5016 100%);
            transition: width 0.3s;
        }

        .alert-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-box.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-box.success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .alert-box.info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåø Spring Touch Training Center - Ultimate Edition</h1>
            <p>Complete AI Training System with Analytics, Adaptive Learning & Team Management</p>
            <div>
                <span class="badge">üìä Progress Tracking</span>
                <span class="badge">üß† Adaptive Difficulty</span>
                <span class="badge">üèÜ Leaderboard</span>
                <span class="badge premium">üìà Team Analytics</span>
                <span class="badge premium">üìÅ Excel Export</span>
                <span class="badge premium">üé§ Call Upload</span>
                <span class="badge premium">üëî Manager Dashboard</span>
            </div>
        </div>

        <div class="role-selector">
            <div class="role-btn active" onclick="setRole('agent')" id="roleAgent">
                <h3>üéß I'm an Agent</h3>
                <p>Practice retention skills and track my progress</p>
            </div>
            <div class="role-btn" onclick="setRole('manager')" id="roleManager">
                <h3>üëî I'm a Manager</h3>
                <p>View team analytics and manage training</p>
            </div>
        </div>

        <div class="user-panel">
            <div class="user-input">
                <label for="agentName">Your Name:</label>
                <input type="text" id="agentName" placeholder="Enter your name" onchange="loadUserData()">
                <button class="btn btn-primary" onclick="loadUserData()">Load My Progress</button>
            </div>
            <div class="user-stats" id="userStats">
                <div class="stat-box">
                    <div class="label">Total Sessions</div>
                    <div class="value" id="totalSessions">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Avg Score</div>
                    <div class="value" id="avgScore">0%</div>
                </div>
                <div class="stat-box">
                    <div class="label">Best Scenario</div>
                    <div class="value" id="bestScenario" style="font-size: 1.2em;">-</div>
                </div>
                <div class="stat-box">
                    <div class="label">Improvement</div>
                    <div class="value" id="improvement">-</div>
                </div>
                <div class="stat-box">
                    <div class="label">Current Level</div>
                    <div class="value" id="currentLevel" style="font-size: 1.2em;">Beginner</div>
                </div>
            </div>
        </div>

        <!-- ElevenLabs Settings Panel -->
        <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #0c4a6e;">üéôÔ∏è ElevenLabs Ultra-Realistic Voices</h3>
                <button class="btn" onclick="toggleElevenLabsSettings()" style="background: #0ea5e9; color: white; padding: 8px 16px; font-size: 0.9em;">
                    ‚öôÔ∏è Configure
                </button>
            </div>
            
            <div id="elevenLabsStatus" style="padding: 10px; border-radius: 6px; background: #fef3c7; border-left: 4px solid #f59e0b;">
                <strong>Status:</strong> <span id="elevenLabsStatusText">Using Browser Voices (Free)</span>
            </div>

            <div id="elevenLabsSettings" style="display: none;">
                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1e293b;">
                            API Key:
                        </label>
                        <input type="password" id="elevenLabsApiKey" placeholder="Enter your ElevenLabs API key" 
                               style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 6px; font-size: 1em;">
                        <small style="color: #64748b;">Get your API key from: <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" style="color: #0ea5e9;">elevenlabs.io</a></small>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1e293b;">
                            Voice:
                        </label>
                        <select id="elevenLabsVoiceId" style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 6px; font-size: 1em;">
                            <option value="21m00Tcm4TlvDq8ikWAM">Rachel - Calm, Professional Female</option>
                            <option value="AZnzlk1XvdvUeBnXmlld">Domi - Strong, Confident Female</option>
                            <option value="EXAVITQu4vr4xnSDxMaL">Bella - Soft, Pleasant Female</option>
                            <option value="ErXwobaYiN019PkySvjV">Antoni - Warm, Professional Male</option>
                            <option value="VR6AewLTigWG4xSOukaG">Arnold - Crisp, Business Male</option>
                            <option value="pNInz6obpgDQGcFmaJgB">Adam - Deep, Authoritative Male</option>
                            <option value="yoZ06aMxZJJ28mfd3POQ">Sam - Dynamic, Energetic Male</option>
                            <option value="TxGEqnHWrfWFTfGW9XjX">Josh - Young, Friendly Male</option>
                        </select>
                        <small style="color: #64748b;">Browse all voices: <a href="https://elevenlabs.io/voice-library" target="_blank" style="color: #0ea5e9;">Voice Library</a></small>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1e293b;">
                                Stability (0-1):
                            </label>
                            <input type="number" id="elevenLabsStability" value="0.5" min="0" max="1" step="0.05"
                                   style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 6px;">
                            <small style="color: #64748b;">Lower = more expressive</small>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1e293b;">
                                Similarity (0-1):
                            </label>
                            <input type="number" id="elevenLabsSimilarity" value="0.75" min="0" max="1" step="0.05"
                                   style="width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 6px;">
                            <small style="color: #64748b;">Higher = more consistent</small>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveElevenLabsSettings()" style="flex: 1; min-width: 200px;">
                            üíæ Save & Enable
                        </button>
                        <button class="btn" onclick="testElevenLabsVoice()" style="flex: 1; min-width: 150px; background: #0ea5e9; color: white;">
                            üîä Test Voice
                        </button>
                        <button class="btn" onclick="disableElevenLabs()" style="background: #64748b; color: white;">
                            ‚ùå Disable
                        </button>
                    </div>
                </div>
            </div>

            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('training', event)">üéØ Training</button>
                <button class="tab-button" onclick="switchTab('history', event)">üìö My History</button>
                <button class="tab-button" onclick="switchTab('insights', event)">üí° Insights</button>
                <button class="tab-button" onclick="switchTab('leaderboard', event)">üèÜ Leaderboard</button>
                <button class="tab-button" onclick="switchTab('upload', event)">üé§ Upload Calls</button>
                <button class="tab-button manager-only" onclick="switchTab('teamanalytics', event)" style="display: none;" id="tabTeamAnalytics">üìä Team Analytics</button>
                <button class="tab-button manager-only" onclick="switchTab('managerdash', event)" style="display: none;" id="tabManagerDash">üëî Manager Dashboard</button>
            </div>

            <div id="training" class="tab-content active">
                <div id="adaptiveNotice" class="adaptive-notice" style="display: none;">
                    <strong>üéØ Adaptive Training Active:</strong> <span id="adaptiveMessage"></span>
                </div>

                <div class="scenario-selector">
                    <label for="scenario">Select Scenario:</label>
                    <select id="scenario" onchange="updateScenarioInfo()">
                        <option value="auto">ü§ñ Auto-Select (Adaptive)</option>
                        <option value="moving">Moving (Random: Local or Out of State)</option>
                        <option value="financial">Budget Concerns - Lost Job</option>
                        <option value="bad_service">Missed Appointments</option>
                        <option value="not_working">Weeds Still Present</option>
                        <option value="competitor">Cheaper Competitor Offer</option>
                    </select>
                </div>

                <div class="scenario-info" id="scenarioInfo">
                    <h3>Ready to Begin</h3>
                    <p>Enter your name above and click "Start Training"</p>
                </div>

                <div class="metrics-display" id="metricsDisplay" style="display: none;">
                    <div><strong>Customer Receptiveness:</strong></div>
                    <div class="receptiveness-bar-container">
                        <div class="receptiveness-bar" id="receptivenessBar"></div>
                    </div>
                    <span id="receptivenessText">50%</span>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div><strong>Good Moves:</strong> <span id="goodMovesCount">0</span></div>
                        <div><strong>Bad Moves:</strong> <span id="badMovesCount">0</span></div>
                        <div><strong>Exchanges:</strong> <span id="exchangesCount">0</span></div>
                    </div>
                </div>

                <div class="status waiting" id="status">Ready to Start</div>

                <div class="controls">
                    <button class="btn btn-primary" id="startBtn" onclick="startTraining()">‚ñ∂Ô∏è Start Training</button>
                    <button class="btn btn-primary" id="endBtn" onclick="endCall()" disabled style="background: #f56565;">‚èπÔ∏è End Call</button>
                </div>

                <div class="input-area">
                    <textarea id="agentInput" placeholder="Type your response here..." disabled></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" id="voiceBtn" onclick="toggleVoice()" disabled style="flex: 1; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            üé§ Push to Talk
                        </button>
                        <button class="btn btn-primary" id="sendBtn" onclick="sendResponse()" style="flex: 2;" disabled>üì§ Send Response</button>
                    </div>
                </div>

                <div class="conversation" id="conversation">
                    <p style="color: #a0aec0; text-align: center;">Conversation will appear here...</p>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-export" id="downloadTranscriptBtn" onclick="downloadTranscript()" disabled style="flex: 1;">
                        üì• Download Transcript
                    </button>
                    <button class="btn btn-export" id="downloadFeedbackBtn" onclick="downloadFeedback()" disabled style="flex: 1;">
                        üì• Download Feedback
                    </button>
                </div>

                <div class="card" id="feedbackCard" style="display: none; margin-top: 20px;">
                    <h3>Performance Feedback</h3>
                    <div id="sessionFeedback"></div>
                </div>
            </div>

            <div id="history" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>My Training History</h2>
                    <button class="btn btn-export" onclick="exportMyData()">üì• Export My Data to Excel</button>
                </div>
                <div class="history-list" id="historyList">
                    <p style="color: #a0aec0; text-align: center;">No training sessions yet.</p>
                </div>
            </div>

            <div id="insights" class="tab-content">
                <h2>Personal Insights & Progress</h2>
                
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                    <p style="color: #718096;">Progress chart will appear after 3+ sessions</p>
                </div>

                <div class="insights-grid" id="insightsGrid">
                    <div class="insight-card">
                        <h4>üí™ Your Strengths</h4>
                        <p id="strengths">Complete more sessions to see patterns...</p>
                    </div>
                    <div class="insight-card">
                        <h4>üéØ Focus Areas</h4>
                        <p id="focusAreas">Complete more sessions to see patterns...</p>
                    </div>
                    <div class="insight-card">
                        <h4>üìà Progress Trend</h4>
                        <p id="progressTrend">Complete more sessions to see trends...</p>
                    </div>
                    <div class="insight-card">
                        <h4>üèÖ Recommended Next</h4>
                        <p id="recommended">Try different scenario types for balanced training</p>
                    </div>
                    <div class="insight-card">
                        <h4>‚ö° Training Velocity</h4>
                        <p id="velocity">-</p>
                    </div>
                    <div class="insight-card">
                        <h4>üéì Skill Level</h4>
                        <p id="skillLevel">Beginner</p>
                    </div>
                </div>
            </div>

            <div id="leaderboard" class="tab-content">
                <h2>Team Leaderboard</h2>
                <p style="margin-bottom: 20px; color: #4a5568;">Top performers based on average scores across all sessions</p>
                <div class="leaderboard" id="leaderboardList">
                    <p style="color: #a0aec0; text-align: center;">No data yet.</p>
                </div>
            </div>

            <div id="upload" class="tab-content">
                <h2>Upload Real Customer Calls</h2>
                <div class="alert-box info">
                    <strong>üí° How it works:</strong> Upload recordings of actual customer cancellation calls. The system will analyze them and create custom training scenarios based on real situations your team faces.
                </div>

                <div class="upload-zone" id="uploadZone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
                    <h3>üìÅ Drop audio files here or click to browse</h3>
                    <p>Supported formats: MP3, WAV, M4A</p>
                    <input type="file" id="fileInput" accept=".mp3,.wav,.m4a" style="display: none;" multiple onchange="handleFiles(this.files)">
                </div>

                <div class="call-list" id="callList">
                    <!-- Uploaded calls will appear here -->
                </div>
            </div>

            <div id="teamanalytics" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>Team Analytics Dashboard</h2>
                    <button class="btn btn-export" onclick="exportTeamData()">üì• Export Team Report to Excel</button>
                </div>

                <div class="team-metrics">
                    <div class="metric-card">
                        <div class="value" id="teamTotalSessions">0</div>
                        <div class="label">Total Sessions</div>
                    </div>
                    <div class="metric-card">
                        <div class="value" id="teamAvgScore">0%</div>
                        <div class="label">Team Avg Score</div>
                    </div>
                    <div class="metric-card">
                        <div class="value" id="teamActiveAgents">0</div>
                        <div class="label">Active Agents</div>
                    </div>
                    <div class="metric-card">
                        <div class="value" id="teamImprovement">-</div>
                        <div class="label">Team Improvement</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Team Performance Trends</h3>
                    <div class="chart-container">
                        <p style="color: #718096;">Team performance chart</p>
                    </div>
                </div>

                <div class="card">
                    <h3>üéØ Scenario Performance Breakdown</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>Moving Scenarios</h4>
                            <p id="movingPerf">Avg: -</p>
                        </div>
                        <div class="insight-card">
                            <h4>Financial Scenarios</h4>
                            <p id="financialPerf">Avg: -</p>
                        </div>
                        <div class="insight-card">
                            <h4>Bad Service Scenarios</h4>
                            <p id="badServicePerf">Avg: -</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚ö†Ô∏è Agents Needing Support</h3>
                    <div id="needsSupport">
                        <p style="color: #a0aec0;">All agents are performing well!</p>
                    </div>
                </div>
            </div>

            <div id="managerdash" class="tab-content">
                <h2>Manager Dashboard</h2>
                
                <div class="alert-box warning">
                    <strong>üéØ Action Items:</strong> <span id="actionItems">Review agents with declining scores</span>
                </div>

                <div class="card">
                    <h3>üë• Agent Performance Overview</h3>
                    <table class="agent-table" id="agentTable">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>Sessions</th>
                                <th>Avg Score</th>
                                <th>Improvement</th>
                                <th>Last Active</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="agentTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #a0aec0;">No agent data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <h3>üéì Training Recommendations</h3>
                    <div id="trainingRecs">
                        <p>‚Ä¢ Schedule weekly team training sessions</p>
                        <p>‚Ä¢ Focus on bad service scenarios (lowest team score)</p>
                        <p>‚Ä¢ Recognize top performers in team meeting</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== SUPABASE CENTRALIZED DATABASE ==========
        const SUPABASE_URL = 'https://twzdiyzkmsxlsvzxisri.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3emRpeXprbXN4bHN2enhpc3JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMTEyMTcsImV4cCI6MjA4MTU4NzIxN30.4zeZ5S_MZk7wPDqBTsTkvqaWU1PawDyljnG4pDms9E0';
        
        let supabaseClient = null;
        let useDatabase = true; // Set to false to disable centralized database
        let currentUser = '';

        // Initialize Supabase on page load
        window.addEventListener('DOMContentLoaded', async function() {
            if (useDatabase && typeof supabase !== 'undefined') {
                try {
                    const { createClient } = supabase;
                    supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('‚úÖ Centralized database connected!');
                    showDatabaseNotification('‚úÖ Connected to team database - All data synced!', 'success');
                } catch (error) {
                    console.error('Database connection error:', error);
                    showDatabaseNotification('‚ö†Ô∏è Database unavailable - Using local storage', 'warning');
                    supabaseClient = null;
                }
            }
        });

        function showDatabaseNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                ${type === 'success' ? 'background: #d1fae5; color: #065f46; border-left: 4px solid #10b981;' : 'background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b;'}
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        // Scenario definitions with difficulty levels and full conversation data
        const SCENARIOS = {
            moving: [
                {
                    name: "Moving Out of State",
                    difficulty: "easy",
                    baseScore: 70,
                    opening: "Hi, I need to cancel my lawn service. I'm moving to Arizona next month for a new job.",
                    concern: "moving"
                },
                {
                    name: "Moving Within Service Area",
                    difficulty: "easy",
                    baseScore: 80,
                    opening: "Hi, I'm calling about my lawn service. I'm moving to a new house about 8 miles from here and wanted to see about transferring my service.",
                    concern: "moving"
                }
            ],
            financial: {
                name: "Budget Concerns - Lost Job",
                difficulty: "medium",
                baseScore: 60,
                opening: "Hi, I'm calling to cancel my service. I lost my job last month and need to cut all my expenses.",
                concern: "financial"
            },
            bad_service: {
                name: "Missed Appointments",
                difficulty: "hard",
                baseScore: 40,
                opening: "I'm calling to cancel. Your tech has missed the last three appointments and I'm fed up with this.",
                concern: "service quality"
            },
            not_working: {
                name: "Treatment Not Working - Weeds",
                difficulty: "medium",
                baseScore: 55,
                opening: "I need to cancel. I've been paying you for six months and my lawn still has weeds everywhere. This isn't working.",
                concern: "results"
            },
            competitor: {
                name: "Cheaper Competitor",
                difficulty: "medium",
                baseScore: 65,
                opening: "I got a quote from TruGreen that's $40 a month cheaper than you guys. I think I'm going to switch.",
                concern: "price"
            }
        };



        // Initialize speech recognition
        window.onload = function() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    console.log('üé§ Speech recognition started');
                    isListening = true;
                    document.getElementById('voiceBtn').textContent = 'üõë Recording... Click to Stop';
                    document.getElementById('voiceBtn').style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    updateStatus('üé§ Listening... Speak now', 'speaking');
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    const confidence = event.results[0][0].confidence;
                    console.log('‚úÖ Recognized:', transcript, '(Confidence:', confidence, ')');
                    document.getElementById('agentInput').value = transcript;
                    isListening = false;
                    document.getElementById('voiceBtn').textContent = 'üé§ Push to Talk';
                    document.getElementById('voiceBtn').style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                    updateStatus('‚úÖ Got it! Review and click Send', 'waiting');
                };

                recognition.onerror = function(event) {
                    console.error('‚ùå Speech recognition error:', event.error);
                    isListening = false;
                    document.getElementById('voiceBtn').textContent = 'üé§ Push to Talk';
                    document.getElementById('voiceBtn').style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                    
                    if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                        alert('üö´ Microphone Access Denied\n\nTo use voice input:\n1. Click the üîí or üõ°Ô∏è icon in your browser address bar\n2. Allow microphone access\n3. Refresh the page\n4. Try again');
                        updateStatus('Microphone permission denied - check browser settings', 'waiting');
                    } else if (event.error === 'no-speech') {
                        updateStatus('‚ö†Ô∏è No speech detected - try speaking louder or closer to mic', 'waiting');
                    } else if (event.error === 'audio-capture') {
                        alert('üé§ No Microphone Detected\n\nMake sure:\n‚Ä¢ A microphone is connected\n‚Ä¢ It\'s not being used by another app\n‚Ä¢ It\'s selected as the default device');
                        updateStatus('No microphone found - check your device', 'waiting');
                    } else if (event.error === 'network') {
                        updateStatus('‚ö†Ô∏è Network error - check your internet connection', 'waiting');
                    } else {
                        updateStatus('‚ö†Ô∏è Voice recognition error: ' + event.error, 'waiting');
                    }
                };

                recognition.onend = function() {
                    console.log('üî¥ Speech recognition ended');
                    isListening = false;
                    document.getElementById('voiceBtn').textContent = 'üé§ Push to Talk';
                    document.getElementById('voiceBtn').style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                };

                // Test microphone permissions on load
                checkMicrophonePermission();
            } else {
                console.warn('‚ö†Ô∏è Speech recognition not supported');
                document.getElementById('voiceBtn').innerHTML = '‚ö†Ô∏è Voice Not Supported';
                document.getElementById('voiceBtn').title = 'Speech recognition requires Chrome, Edge, or Safari';
                document.getElementById('voiceBtn').style.background = '#94a3b8';
            }
        };

        async function checkMicrophonePermission() {
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    console.log('üé§ Microphone permission:', result.state);
                    
                    if (result.state === 'denied') {
                        console.warn('‚ö†Ô∏è Microphone access is denied');
                    }
                    
                    result.onchange = function() {
                        console.log('üé§ Microphone permission changed to:', this.state);
                    };
                }
            } catch (error) {
                console.log('Could not check microphone permission:', error);
            }
        }

        function toggleVoice() {
            if (!recognition) {
                alert('Voice input is not supported in your browser.\n\nSupported browsers:\n‚Ä¢ Chrome\n‚Ä¢ Edge\n‚Ä¢ Safari\n\nPlease use one of these browsers to use voice input.');
                return;
            }

            if (isListening) {
                console.log('Stopping recognition...');
                recognition.stop();
            } else {
                console.log('Starting recognition...');
                try {
                    document.getElementById('agentInput').value = ''; // Clear previous text
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    if (error.name === 'InvalidStateError') {
                        // Recognition is already running, stop it first
                        recognition.stop();
                        setTimeout(() => {
                            recognition.start();
                        }, 100);
                    } else {
                        alert('Could not start voice input.\n\nTroubleshooting:\n1. Make sure your microphone is connected\n2. Check browser permissions (click üîí in address bar)\n3. Close other apps using the microphone\n4. Refresh the page and try again');
                    }
                }
            }
        }

        async function speakText(text) {
            if (!voiceEnabled) {
                return;
            }

            // Use ElevenLabs if enabled and configured
            if (ELEVENLABS_CONFIG.enabled && ELEVENLABS_CONFIG.apiKey) {
                await speakWithElevenLabs(text);
            } else {
                // Fall back to browser speech synthesis
                speakWithBrowser(text);
            }
        }

        async function speakWithElevenLabs(text) {
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVENLABS_CONFIG.voiceId}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': ELEVENLABS_CONFIG.apiKey
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: ELEVENLABS_CONFIG.model,
                        voice_settings: {
                            stability: ELEVENLABS_CONFIG.stability,
                            similarity_boost: ELEVENLABS_CONFIG.similarityBoost
                        }
                    })
                });

                if (!response.ok) {
                    console.error('ElevenLabs API error:', response.status);
                    // Fall back to browser voice
                    speakWithBrowser(text);
                    return;
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                };
                
                await audio.play();
            } catch (error) {
                console.error('ElevenLabs TTS error:', error);
                // Fall back to browser voice
                speakWithBrowser(text);
            }
        }

        function speakWithBrowser(text) {
            if (!('speechSynthesis' in window)) {
                return;
            }

            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Try to use a natural voice
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.name.includes('Google') || 
                voice.name.includes('Natural') ||
                voice.name.includes('Samantha') ||
                voice.name.includes('Alex')
            );
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }

            window.speechSynthesis.speak(utterance);
        }


        function setRole(role) {
            currentRole = role;
            document.getElementById('roleAgent').classList.toggle('active', role === 'agent');
            document.getElementById('roleManager').classList.toggle('active', role === 'manager');
            
            const showManager = role === 'manager';
            document.getElementById('tabTeamAnalytics').style.display = showManager ? 'block' : 'none';
            document.getElementById('tabManagerDash').style.display = showManager ? 'block' : 'none';
        }

        // ElevenLabs Settings Functions
        function toggleElevenLabsSettings() {
            const settings = document.getElementById('elevenLabsSettings');
            settings.style.display = settings.style.display === 'none' ? 'block' : 'none';
            
            // Load saved settings if they exist
            const saved = localStorage.getItem('elevenlabs_config');
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('elevenLabsApiKey').value = config.apiKey || '';
                document.getElementById('elevenLabsVoiceId').value = config.voiceId || '21m00Tcm4TlvDq8ikWAM';
                document.getElementById('elevenLabsStability').value = config.stability || 0.5;
                document.getElementById('elevenLabsSimilarity').value = config.similarityBoost || 0.75;
            }
        }

        function saveElevenLabsSettings() {
            const apiKey = document.getElementById('elevenLabsApiKey').value.trim();
            
            if (!apiKey) {
                alert('Please enter your ElevenLabs API key.\n\nGet one free at: https://elevenlabs.io/app/settings/api-keys');
                return;
            }

            ELEVENLABS_CONFIG.enabled = true;
            ELEVENLABS_CONFIG.apiKey = apiKey;
            ELEVENLABS_CONFIG.voiceId = document.getElementById('elevenLabsVoiceId').value;
            ELEVENLABS_CONFIG.stability = parseFloat(document.getElementById('elevenLabsStability').value);
            ELEVENLABS_CONFIG.similarityBoost = parseFloat(document.getElementById('elevenLabsSimilarity').value);

            // Save to localStorage
            localStorage.setItem('elevenlabs_config', JSON.stringify(ELEVENLABS_CONFIG));

            // Update status
            updateElevenLabsStatus();

            alert('‚úÖ ElevenLabs enabled! Ultra-realistic voices will now be used.\n\nClick "Test Voice" to hear it!');
        }

        function testElevenLabsVoice() {
            const testText = "Hi, I need to cancel my lawn service. I'm moving to Arizona next month for a new job.";
            
            // Temporarily save settings for test
            const tempApiKey = document.getElementById('elevenLabsApiKey').value.trim();
            if (!tempApiKey) {
                alert('Please enter your API key first!');
                return;
            }

            const tempConfig = {
                enabled: true,
                apiKey: tempApiKey,
                voiceId: document.getElementById('elevenLabsVoiceId').value,
                stability: parseFloat(document.getElementById('elevenLabsStability').value),
                similarityBoost: parseFloat(document.getElementById('elevenLabsSimilarity').value)
            };

            // Test the voice
            testElevenLabsAPI(testText, tempConfig);
        }

        async function testElevenLabsAPI(text, config) {
            try {
                updateStatus('üîä Testing ElevenLabs voice...', 'waiting');
                
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${config.voiceId}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': config.apiKey
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_monolingual_v1',
                        voice_settings: {
                            stability: config.stability,
                            similarity_boost: config.similarityBoost
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    updateStatus('Ready to Start', 'waiting');
                };
                
                await audio.play();
                
            } catch (error) {
                console.error('ElevenLabs test error:', error);
                alert('‚ùå Error testing voice:\n\n' + error.message + '\n\nPlease check:\n‚Ä¢ API key is correct\n‚Ä¢ You have API credits\n‚Ä¢ Internet connection is working');
                updateStatus('Ready to Start', 'waiting');
            }
        }

        function disableElevenLabs() {
            ELEVENLABS_CONFIG.enabled = false;
            localStorage.removeItem('elevenlabs_config');
            updateElevenLabsStatus();
            alert('‚úÖ ElevenLabs disabled. Now using free browser voices.');
        }

        function updateElevenLabsStatus() {
            const statusText = document.getElementById('elevenLabsStatusText');
            const statusDiv = document.getElementById('elevenLabsStatus');
            
            if (ELEVENLABS_CONFIG.enabled && ELEVENLABS_CONFIG.apiKey) {
                statusText.textContent = '‚úÖ ElevenLabs Active - Ultra-Realistic Voices';
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.borderLeftColor = '#10b981';
            } else {
                statusText.textContent = 'Using Browser Voices (Free)';
                statusDiv.style.background = '#fef3c7';
                statusDiv.style.borderLeftColor = '#f59e0b';
            }
        }

        // Load ElevenLabs settings on page load
        window.addEventListener('load', function() {
            const saved = localStorage.getItem('elevenlabs_config');
            if (saved) {
                const config = JSON.parse(saved);
                ELEVENLABS_CONFIG.enabled = config.enabled || false;
                ELEVENLABS_CONFIG.apiKey = config.apiKey || '';
                ELEVENLABS_CONFIG.voiceId = config.voiceId || '21m00Tcm4TlvDq8ikWAM';
                ELEVENLABS_CONFIG.stability = config.stability || 0.5;
                ELEVENLABS_CONFIG.similarityBoost = config.similarityBoost || 0.75;
                updateElevenLabsStatus();
            }
        });

        function switchTab(tabName, event) {
            // Get the clicked button - either from event or find it by tabName
            let clickedButton;
            if (event && event.target) {
                clickedButton = event.target;
            } else {
                // Find the button that was clicked by matching the onclick attribute
                clickedButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => 
                    btn.getAttribute('onclick').includes(`'${tabName}'`)
                );
            }
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'history') loadHistory();
            if (tabName === 'insights') loadInsights();
            if (tabName === 'leaderboard') loadLeaderboard();
            if (tabName === 'teamanalytics') loadTeamAnalytics();
            if (tabName === 'managerdash') loadManagerDashboard();
        }        async function loadUserData() {
            currentUser = document.getElementById('agentName').value.trim();
            if (!currentUser) {
                alert('Please enter your name');
                return;
            }

            if (supabaseClient && useDatabase) {
                try {
                    const { data: agent, error } = await supabaseClient
                        .from('agents')
                        .select('*')
                        .eq('name', currentUser)
                        .maybeSingle();

                    if (agent) {
                        document.getElementById('totalSessions').textContent = agent.total_sessions || 0;
                        document.getElementById('avgScore').textContent = (agent.avg_score || 0) + '%';
                        document.getElementById('bestScenario').textContent = agent.best_scenario || '-';
                        document.getElementById('improvement').textContent = 
                            (agent.improvement || 0) > 0 ? '+' + agent.improvement + '%' : (agent.improvement || 0) + '%';
                        document.getElementById('currentLevel').textContent = agent.skill_level || 'Beginner';
                        
                        console.log('‚úÖ Loaded data from centralized database');
                    } else {
                        // New user - set defaults
                        document.getElementById('totalSessions').textContent = '0';
                        document.getElementById('avgScore').textContent = '0%';
                        document.getElementById('bestScenario').textContent = '-';
                        document.getElementById('improvement').textContent = '-';
                        document.getElementById('currentLevel').textContent = 'Beginner';
                    }
                } catch (error) {
                    console.error('Error loading from database:', error);
                    loadUserDataFromLocalStorage();
                }
            } else {
                loadUserDataFromLocalStorage();
            }
        }

        function loadUserDataFromLocalStorage() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (user) {
                document.getElementById('totalSessions').textContent = user.totalSessions || 0;
                document.getElementById('avgScore').textContent = (user.avgScore || 0) + '%';
                document.getElementById('bestScenario').textContent = user.bestScenario || '-';
                document.getElementById('improvement').textContent = 
                    (user.improvement || 0) > 0 ? '+' + user.improvement + '%' : (user.improvement || 0) + '%';
                document.getElementById('currentLevel').textContent = user.level || 'Beginner';
            } else {
                document.getElementById('totalSessions').textContent = '0';
                document.getElementById('avgScore').textContent = '0%';
                document.getElementById('bestScenario').textContent = '-';
                document.getElementById('improvement').textContent = '-';
                document.getElementById('currentLevel').textContent = 'Beginner';
            }
        }

        function updateAdaptiveRecommendation() {
            const userData = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = userData[currentUser];
            
            if (!user || user.sessions.length < 3) {
                document.getElementById('adaptiveNotice').style.display = 'none';
                return;
            }

            // Calculate which scenarios user struggles with
            const scenarioScores = {};
            user.sessions.forEach(s => {
                if (!scenarioScores[s.scenario]) scenarioScores[s.scenario] = [];
                scenarioScores[s.scenario].push(s.score);
            });

            const avgScores = {};
            Object.keys(scenarioScores).forEach(scenario => {
                const scores = scenarioScores[scenario];
                avgScores[scenario] = scores.reduce((a, b) => a + b, 0) / scores.length;
            });

            const weakestScenario = Object.keys(avgScores).reduce((a, b) => 
                avgScores[a] < avgScores[b] ? a : b
            );

            document.getElementById('adaptiveNotice').style.display = 'block';
            document.getElementById('adaptiveMessage').textContent = 
                `Based on your history, we recommend practicing "${SCENARIOS[weakestScenario].name}" scenarios. Select "Auto-Select" to use adaptive training.`;
        }

        function updateScenarioInfo() {
            const scenario = document.getElementById('scenario').value;
            if (scenario === 'auto') {
                document.getElementById('scenarioInfo').innerHTML = `
                    <h3>ü§ñ Auto-Select Mode</h3>
                    <p>The system will choose the best scenario for your training based on your performance history.</p>
                `;
            }
        }

        function selectAdaptiveScenario() {
            const userData = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = userData[currentUser];
            
            if (!user || user.sessions.length < 3) {
                // Not enough data, select randomly
                const scenarios = Object.keys(SCENARIOS);
                return scenarios[Math.floor(Math.random() * scenarios.length)];
            }

            // Find weakest scenario
            const scenarioScores = {};
            user.sessions.forEach(s => {
                if (!scenarioScores[s.scenario]) scenarioScores[s.scenario] = [];
                scenarioScores[s.scenario].push(s.score);
            });

            const avgScores = {};
            Object.keys(scenarioScores).forEach(scenario => {
                const scores = scenarioScores[scenario];
                avgScores[scenario] = scores.reduce((a, b) => a + b, 0) / scores.length;
            });

            return Object.keys(avgScores).reduce((a, b) => 
                avgScores[a] < avgScores[b] ? a : b
            );
        }

        function startTraining() {
            if (!currentUser) {
                alert('Please enter your name first');
                return;
            }

            let scenarioKey = document.getElementById('scenario').value;
            if (scenarioKey === 'auto') {
                scenarioKey = selectAdaptiveScenario();
            }

            // Handle scenarios that are arrays (like moving)
            let scenarioData = SCENARIOS[scenarioKey];
            if (Array.isArray(scenarioData)) {
                scenarioData = scenarioData[Math.floor(Math.random() * scenarioData.length)];
            }

            currentSession = {
                user: currentUser,
                scenario: scenarioKey,
                scenarioName: scenarioData.name,
                startTime: new Date().toISOString(),
                conversation: [],
                score: 0,
                goodMoves: 0,
                badMoves: 0,
                opening: scenarioData.opening
            };

            document.getElementById('startBtn').disabled = true;
            document.getElementById('endBtn').disabled = false;
            document.getElementById('agentInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('voiceBtn').disabled = false;
            document.getElementById('metricsDisplay').style.display = 'block';

            const difficulty = scenarioData.difficulty;
            const difficultyBadge = `<span class="difficulty-badge ${difficulty}">${difficulty.toUpperCase()}</span>`;

            document.getElementById('scenarioInfo').innerHTML = `
                <h3>${scenarioData.name} ${difficultyBadge}</h3>
                <p><strong>Customer Concern:</strong> ${scenarioData.concern}</p>
                <p>Listen carefully to their reason and practice your retention skills!</p>
            `;

            const opening = scenarioData.opening;
            document.getElementById('conversation').innerHTML = `<div class="message customer"><strong>üë§ Customer</strong>${opening}</div>`;
            currentSession.conversation.push({ role: 'customer', content: opening });

            // Speak the opening
            setTimeout(() => {
                speakText(opening);
            }, 500);

            updateStatus('Your turn - Type or speak your response', 'waiting');
        }

        function sendResponse() {
            const input = document.getElementById('agentInput');
            const response = input.value.trim();

            if (!response) {
                alert('Please type a response first');
                return;
            }

            currentSession.conversation.push({ role: 'agent', content: response });
            
            const conversationEl = document.getElementById('conversation');
            conversationEl.innerHTML += `<div class="message agent"><strong>üéß You</strong>${response}</div>`;
            conversationEl.scrollTop = conversationEl.scrollHeight;
            
            input.value = '';

            // Analyze response quality
            const responseLower = response.toLowerCase();
            const hasEmpathy = /understand|appreciate|thank|hear you|get it|makes sense|sorry|feel|tough|difficult/i.test(response);
            const hasSolution = /offer|can|help|would|option|plan|discount|match|save|provide|give/i.test(response);
            const isPushy = /must|should|need to|have to|wrong|mistake|required|necessary/i.test(response);
            const hasPrice = /price|cost|\$|dollar|match|lower|reduce|discount|deal|save money/i.test(response);
            const hasQuality = /quality|local|service|better|experience|guarantee|family|trust|reliable/i.test(response);
            const hasWarning = /bait|switch|increase|fine print|first year|promotional|raise|double|triple/i.test(response);
            const hasCredit = /credit|refund|comp|free|discount|money back/i.test(response);
            const hasAction = /will|going to|schedule|arrange|personally|manager|supervisor|ensure/i.test(response);
            const hasPause = /pause|suspend|hold|temporary|freeze|stop for now/i.test(response);
            const hasPayment = /payment|split|installment|bi-weekly|monthly|spread out|smaller/i.test(response);
            const hasInspection = /look|inspect|come out|visit|check|evaluate|assess/i.test(response);
            const hasTransfer = /transfer|move|new address|continue|keep service/i.test(response);

            if (hasEmpathy) currentSession.goodMoves++;
            if (hasSolution) currentSession.goodMoves++;
            if (isPushy) currentSession.badMoves++;

            // Calculate exchanges
            const exchanges = Math.floor(currentSession.conversation.length / 2);

            // Simulate customer response based on scenario and agent approach
            setTimeout(() => {
                let customerResponse = "";
                const scenario = currentSession.scenario;

                // Check if conversation should conclude (after 4 exchanges)
                if (exchanges >= 4) {
                    const currentScore = currentSession.score || 50;
                    if (currentScore >= 75) {
                        const goodEndings = [
                            "You know what, you've made some really good points. Let me think about this before I make a final decision.",
                            "I really appreciate you working with me on this. Let me talk to my spouse and I'll call you back.",
                            "Okay, that actually sounds reasonable. Let's give this a try and see how it goes.",
                            "You've been very helpful. I'm willing to keep the service with these changes you've offered."
                        ];
                        customerResponse = goodEndings[Math.floor(Math.random() * goodEndings.length)];
                    } else if (currentScore >= 55) {
                        const okayEndings = [
                            "I appreciate your help, but I think I'm still going to go ahead with the cancellation.",
                            "Thanks for trying, but I don't think this is going to work out for me.",
                            "I understand what you're saying, but I've already made my decision. Sorry.",
                            "You've been nice, but I really need to cancel. Thank you though."
                        ];
                        customerResponse = okayEndings[Math.floor(Math.random() * okayEndings.length)];
                    } else {
                        const poorEndings = [
                            "Look, I've made my decision. I need to cancel. Thank you for your time.",
                            "I don't think this conversation is going anywhere. Please just cancel my service.",
                            "I appreciate you trying, but I'm done. I'd like to cancel now please.",
                            "This isn't working. I'm going to cancel. Have a good day."
                        ];
                        customerResponse = poorEndings[Math.floor(Math.random() * poorEndings.length)];
                    }
                } else {
                    // Scenario-specific intelligent responses
                    if (scenario === 'competitor') {
                        if (exchanges === 1) {
                            if (hasQuality && !hasPrice) {
                                customerResponse = "That's a good point about quality and local service. But they're still $40 cheaper - that's real money every month.";
                            } else if (hasWarning) {
                                customerResponse = "Really? It does say 'promotional rate' in the fine print. What usually happens after the first year?";
                            } else if (hasPrice) {
                                customerResponse = "Can you actually match their price? Because if not, I don't see a reason to stay.";
                            } else if (isPushy) {
                                customerResponse = "I'm not making a mistake - I'm trying to save money. Please don't talk down to me.";
                            } else if (hasEmpathy) {
                                customerResponse = "Thanks for understanding. But $40 a month is almost $500 a year - that matters to my family.";
                            } else {
                                customerResponse = "I appreciate that, but at the end of the day, price really matters to me.";
                            }
                        } else if (exchanges === 2) {
                            if (hasWarning && hasQuality) {
                                customerResponse = "You're right, I should read the fine print more carefully. And I do like having a local company...";
                            } else if (hasPrice && responseLower.includes('match')) {
                                customerResponse = "So you can actually match their price? For how long - is this just temporary too?";
                            } else if (hasPrice && responseLower.includes('discount')) {
                                customerResponse = "How much of a discount are we talking about? Can you get close to their price?";
                            } else {
                                customerResponse = "I hear what you're saying, but I'm still not convinced it's worth $40 more per month.";
                            }
                        } else {
                            if (hasPrice || responseLower.includes('15%') || responseLower.includes('discount')) {
                                customerResponse = "Okay, that does help close the gap. Let me think about whether that's worth it for the better service.";
                            } else if (hasQuality) {
                                customerResponse = "The local service angle is appealing. I do like knowing who's coming to my house...";
                            } else {
                                customerResponse = "I'm still leaning toward switching, to be honest. The savings are hard to ignore.";
                            }
                        }
                    } else if (scenario === 'financial') {
                        if (exchanges === 1) {
                            if (hasPause) {
                                customerResponse = "Wait, I can pause the service? I didn't know that was an option! How long can I pause for?";
                            } else if (hasPayment) {
                                customerResponse = "Payment plans might help. Can I do smaller payments more frequently? That would be easier on my budget.";
                            } else if (hasEmpathy && hasSolution) {
                                customerResponse = "Thank you, I appreciate you understanding. What kind of options do you have?";
                            } else if (isPushy) {
                                customerResponse = "I literally can't afford it. Telling me I 'need' to keep it doesn't help my situation.";
                            } else if (hasEmpathy) {
                                customerResponse = "Thanks for understanding. It's been really stressful with the job loss.";
                            } else {
                                customerResponse = "I understand, but money is really tight right now. I have to cut expenses.";
                            }
                        } else if (exchanges === 2) {
                            if (hasPause && responseLower.includes('month')) {
                                customerResponse = "So I could pause for a few months until I find a new job? Is there a fee to restart?";
                            } else if (hasPayment) {
                                customerResponse = "Okay, breaking it into smaller payments could actually work. How would that be set up?";
                            } else if (responseLower.includes('reduce') || responseLower.includes('basic')) {
                                customerResponse = "A reduced service level... what would that include? Just the basics to keep weeds down?";
                            } else {
                                customerResponse = "I appreciate the options, but I'm not sure any of them work with my current situation.";
                            }
                        } else {
                            if (hasPause || hasPayment) {
                                customerResponse = "You know, that payment plan option might actually let me keep the service. Let me think about it.";
                            } else if (responseLower.includes('prepay') || responseLower.includes('discount')) {
                                customerResponse = "A discount would help, but I don't have money to prepay right now since I lost my job.";
                            } else {
                                customerResponse = "I really do want to keep the service, but I just can't afford it right now.";
                            }
                        }
                    } else if (scenario === 'bad_service') {
                        if (exchanges === 1) {
                            if (responseLower.includes('sorry') || responseLower.includes('apologize')) {
                                customerResponse = "I appreciate the apology, but I need more than words. What are you actually going to DO about it?";
                            } else if (hasCredit) {
                                customerResponse = "Okay, a credit is something. How much are we talking about? And what about the missed appointments?";
                            } else if (hasAction) {
                                customerResponse = "What exactly will you do differently? Because I've been through this before with empty promises.";
                            } else if (isPushy || responseLower.includes('happen')) {
                                customerResponse = "Three times in a row isn't just 'something that happens' - it's unacceptable. Don't make excuses.";
                            } else {
                                customerResponse = "I've heard this all before. Talk is cheap - I need to see actual changes.";
                            }
                        } else if (exchanges === 2) {
                            if (hasAction && responseLower.includes('dedicated')) {
                                customerResponse = "A dedicated tech who actually shows up? That would be a big improvement. Can you guarantee that?";
                            } else if (hasCredit && (responseLower.includes('month') || responseLower.includes('free'))) {
                                customerResponse = "That's a reasonable credit. But I still need assurance this won't keep happening.";
                            } else if (responseLower.includes('manager') || responseLower.includes('supervisor')) {
                                customerResponse = "Having a manager personally handle this does make me feel a bit better about it...";
                            } else {
                                customerResponse = "I'm still not convinced anything will actually change. Why should I believe you this time?";
                            }
                        } else {
                            if (hasCredit && hasAction) {
                                customerResponse = "Okay, between the credit and the dedicated tech assignment, you're taking this seriously. Let me think about it.";
                            } else if (hasEmpathy && hasAction) {
                                customerResponse = "I appreciate you acknowledging the problem and offering a real solution. That helps.";
                            } else {
                                customerResponse = "I've given you guys enough chances. I think it's time to move on to a more reliable company.";
                            }
                        }
                    } else if (scenario === 'not_working') {
                        if (exchanges === 1) {
                            if (hasInspection) {
                                customerResponse = "Okay, having someone come look at it would be good. When can they come? And will this actually fix it?";
                            } else if (responseLower.includes('specialist') || responseLower.includes('expert')) {
                                customerResponse = "A specialist who knows what they're doing - that's what I need. When can they come out?";
                            } else if (responseLower.includes('free') || hasCredit) {
                                customerResponse = "Free re-treatment is the least you can do since I've been paying for nothing. What's different this time?";
                            } else if (isPushy || responseLower.includes('take time')) {
                                customerResponse = "Six months is plenty of time! Don't tell me I need to be more patient.";
                            } else if (hasEmpathy) {
                                customerResponse = "Thanks for understanding my frustration. But I need actual results, not just sympathy.";
                            } else {
                                customerResponse = "I've been patient. I just don't think your product works on my lawn.";
                            }
                        } else if (exchanges === 2) {
                            if (hasInspection && responseLower.includes('week')) {
                                customerResponse = "This week or next week works for me. And they'll figure out what's actually wrong?";
                            } else if (responseLower.includes('different') || responseLower.includes('stronger')) {
                                customerResponse = "So you're saying there's a different treatment that might work better? Why wasn't this used before?";
                            } else if (responseLower.includes('guarantee') || responseLower.includes('promise')) {
                                customerResponse = "What exactly are you guaranteeing? Because clearly the regular guarantee didn't work.";
                            } else {
                                customerResponse = "I'm willing to give it one more shot, but if this doesn't work, I'm definitely canceling.";
                            }
                        } else {
                            if (hasInspection && (hasCredit || responseLower.includes('free'))) {
                                customerResponse = "Okay, having a specialist come out and re-treat for free is fair. One more chance.";
                            } else if (responseLower.includes('different product') || responseLower.includes('stronger')) {
                                customerResponse = "Alright, trying a different approach makes sense. Let's see if this actually works.";
                            } else {
                                customerResponse = "I appreciate you trying, but I've lost faith in your service. I'm going to try someone else.";
                            }
                        }
                    } else if (scenario === 'moving') {
                        const isLocalMove = currentSession.opening && currentSession.opening.includes('8 miles');
                        if (isLocalMove) {
                            if (exchanges === 1) {
                                if (hasTransfer) {
                                    customerResponse = "That's great! So I can keep the same service and just change the address? How does that work?";
                                } else if (responseLower.includes('discount') || responseLower.includes('deal')) {
                                    customerResponse = "Is there a new homeowner discount or something? The new place has a bigger lawn.";
                                } else if (hasInspection) {
                                    customerResponse = "Having someone come look at the new place before I move would be perfect. When can they do that?";
                                } else {
                                    customerResponse = "So can you help me transfer or do I need to cancel and sign up again as a new customer?";
                                }
                            } else {
                                if (hasTransfer && responseLower.includes('easy')) {
                                    customerResponse = "Okay great, that's easier than I thought. What information do you need from me?";
                                } else if (hasInspection) {
                                    customerResponse = "Perfect, I'd love to get the new place inspected. The lawn is in rough shape right now.";
                                } else {
                                    customerResponse = "Awesome, I'm glad I can keep using Spring Touch at my new place!";
                                }
                            }
                        } else {
                            // Moving out of state
                            if (exchanges === 1) {
                                if (hasEmpathy && responseLower.includes('congrat')) {
                                    customerResponse = "Thanks! It's exciting but also really stressful with all the packing and planning.";
                                } else if (responseLower.includes('until') || responseLower.includes('keep')) {
                                    customerResponse = "Hmm, I guess keeping service until I actually move makes sense. When's my next scheduled treatment?";
                                } else if (responseLower.includes('referral') || responseLower.includes('neighbor')) {
                                    customerResponse = "Oh, you want referrals? My neighbor actually was asking about lawn services...";
                                } else {
                                    customerResponse = "I appreciate that, but I still need to cancel since I won't be here.";
                                }
                            } else {
                                if (responseLower.includes('review') || responseLower.includes('google')) {
                                    customerResponse = "Sure, I'd be happy to leave a review. You guys have done a good job with my lawn.";
                                } else if (responseLower.includes('referral')) {
                                    customerResponse = "Yeah, let me give my neighbor your number. They've been asking who I use.";
                                } else {
                                    customerResponse = "Thanks for being understanding. I'll definitely recommend you to people in the area.";
                                }
                            }
                        }
                    } else {
                        // Generic fallback
                        if (hasEmpathy && hasSolution) {
                            customerResponse = "That's helpful, let me think about those options you mentioned.";
                        } else if (isPushy) {
                            customerResponse = "Please don't pressure me. I'm trying to make the right decision here.";
                        } else {
                            customerResponse = "I understand, but I still have concerns about moving forward.";
                        }
                    }
                }
                
                currentSession.conversation.push({ role: 'customer', content: customerResponse });
                conversationEl.innerHTML += `<div class="message customer"><strong>üë§ Customer</strong>${customerResponse}</div>`;
                conversationEl.scrollTop = conversationEl.scrollHeight;

                // Speak customer response
                speakText(customerResponse);

                // Update metrics
                document.getElementById('exchangesCount').textContent = exchanges;
                document.getElementById('goodMovesCount').textContent = currentSession.goodMoves;
                document.getElementById('badMovesCount').textContent = currentSession.badMoves;
                
                // Get base score from the scenario
                let scenarioData = SCENARIOS[currentSession.scenario];
                if (Array.isArray(scenarioData)) {
                    scenarioData = scenarioData[0];
                }
                const baseScore = scenarioData.baseScore;
                const score = Math.min(100, Math.max(0, baseScore + (currentSession.goodMoves * 10) - (currentSession.badMoves * 15)));
                document.getElementById('receptivenessBar').style.width = score + '%';
                document.getElementById('receptivenessText').textContent = score + '%';
                currentSession.score = score;

                // Auto-end hint after natural conclusion
                if (exchanges >= 4 || customerResponse.includes("call you back") || customerResponse.includes("made my decision") || customerResponse.includes("Have a good day")) {
                    setTimeout(() => {
                        if (document.getElementById('endBtn').disabled === false) {
                            updateStatus('üí° Customer has concluded. Click "End Call" to see your results.', 'waiting');
                        }
                    }, 2000);
                }
            }, 1500);
        }

        function endCall() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('endBtn').disabled = true;
            document.getElementById('agentInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('voiceBtn').disabled = true;
            document.getElementById('downloadTranscriptBtn').disabled = false;
            document.getElementById('downloadFeedbackBtn').disabled = false;

            // Stop any ongoing speech
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            if (recognition && isListening) {
                recognition.stop();
            }

            currentSession.endTime = new Date().toISOString();
            
            // Generate and display feedback
            generateFeedback();
            
            saveSession(currentSession);
            updateStatus('Session complete! Download your transcript and feedback below.', 'waiting');
            
            loadUserData();
        }

        function generateFeedback() {
            const score = currentSession.score;
            const goodMoves = currentSession.goodMoves;
            const badMoves = currentSession.badMoves;
            const exchanges = Math.floor(currentSession.conversation.length / 2);

            let rating, saveLikelihood, strengths, improvements;

            if (score >= 80) {
                rating = "Excellent";
                saveLikelihood = "85-95%";
                strengths = "Strong empathy and solution-focused approach. Great job acknowledging the customer's situation and offering specific alternatives.";
                improvements = "Continue this level of performance. Consider mentoring newer team members.";
            } else if (score >= 65) {
                rating = "Good";
                saveLikelihood = "60-75%";
                strengths = "Demonstrated empathy and offered solutions. Good conversational flow.";
                improvements = "Work on being more specific with solutions. Use concrete numbers and timelines when making offers.";
            } else if (score >= 50) {
                rating = "Adequate";
                saveLikelihood = "40-55%";
                strengths = "Made an effort to engage with the customer.";
                improvements = "Focus on showing more empathy before jumping to solutions. Listen actively and acknowledge their concerns more thoroughly.";
            } else {
                rating = "Needs Improvement";
                saveLikelihood = "20-35%";
                strengths = "Attempted to address the cancellation.";
                improvements = "Avoid pushy language. Focus on understanding the customer's situation first. Offer flexible solutions rather than trying to convince them they're wrong.";
            }

            const feedbackHTML = `
                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #2d5016; margin-bottom: 10px;">Overall Rating: ${rating}</h4>
                    <div style="margin-bottom: 15px;">
                        <strong>Customer Retention Likelihood:</strong> ${saveLikelihood}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Session Stats:</strong><br>
                        ‚Ä¢ Score: ${score}%<br>
                        ‚Ä¢ Good Moves: ${goodMoves}<br>
                        ‚Ä¢ Bad Moves: ${badMoves}<br>
                        ‚Ä¢ Total Exchanges: ${exchanges}
                    </div>
                </div>
                <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                    <h4 style="color: #065f46; margin-bottom: 10px;">üí™ Strengths</h4>
                    <p style="margin: 0; color: #065f46;">${strengths}</p>
                </div>
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: #92400e; margin-bottom: 10px;">üéØ Areas for Improvement</h4>
                    <p style="margin: 0; color: #92400e;">${improvements}</p>
                </div>
            `;

            document.getElementById('sessionFeedback').innerHTML = feedbackHTML;
            document.getElementById('feedbackCard').style.display = 'block';
        }

        function downloadTranscript() {
            if (!currentSession) return;

            let content = "SPRING TOUCH TRAINING - CONVERSATION TRANSCRIPT\n";
            content += "=".repeat(60) + "\n\n";
            content += `Agent: ${currentUser}\n`;
            content += `Date: ${new Date(currentSession.startTime).toLocaleString()}\n`;
            content += `Scenario: ${currentSession.scenarioName || 'Training Session'}\n`;
            content += `Final Score: ${currentSession.score}%\n`;
            content += "\n" + "=".repeat(60) + "\n\n";
            content += "CONVERSATION:\n\n";

            currentSession.conversation.forEach((msg, index) => {
                const speaker = msg.role === 'customer' ? 'CUSTOMER' : 'AGENT';
                content += `${speaker}: ${msg.content}\n\n`;
            });

            content += "=".repeat(60) + "\n";
            content += `\nPerformance Metrics:\n`;
            content += `- Good Moves: ${currentSession.goodMoves}\n`;
            content += `- Bad Moves: ${currentSession.badMoves}\n`;
            content += `- Total Exchanges: ${Math.floor(currentSession.conversation.length / 2)}\n`;

            downloadFile(`Spring_Touch_Transcript_${new Date().toISOString().split('T')[0]}.txt`, content);
        }

        function downloadFeedback() {
            if (!currentSession) return;

            const score = currentSession.score;
            let rating, saveLikelihood, strengths, improvements;

            if (score >= 80) {
                rating = "Excellent";
                saveLikelihood = "85-95%";
                strengths = "Strong empathy and solution-focused approach. Great job acknowledging the customer's situation and offering specific alternatives.";
                improvements = "Continue this level of performance. Consider mentoring newer team members.";
            } else if (score >= 65) {
                rating = "Good";
                saveLikelihood = "60-75%";
                strengths = "Demonstrated empathy and offered solutions. Good conversational flow.";
                improvements = "Work on being more specific with solutions. Use concrete numbers and timelines when making offers.";
            } else if (score >= 50) {
                rating = "Adequate";
                saveLikelihood = "40-55%";
                strengths = "Made an effort to engage with the customer.";
                improvements = "Focus on showing more empathy before jumping to solutions. Listen actively and acknowledge their concerns more thoroughly.";
            } else {
                rating = "Needs Improvement";
                saveLikelihood = "20-35%";
                strengths = "Attempted to address the cancellation.";
                improvements = "Avoid pushy language. Focus on understanding the customer's situation first. Offer flexible solutions rather than trying to convince them they're wrong.";
            }

            let content = "SPRING TOUCH TRAINING - PERFORMANCE FEEDBACK\n";
            content += "=".repeat(60) + "\n\n";
            content += `Agent: ${currentUser}\n`;
            content += `Date: ${new Date(currentSession.startTime).toLocaleString()}\n`;
            content += `Scenario: ${currentSession.scenarioName || 'Training Session'}\n\n`;
            content += "=".repeat(60) + "\n\n";
            content += `OVERALL RATING: ${rating}\n\n`;
            content += `Customer Retention Likelihood: ${saveLikelihood}\n\n`;
            content += `SESSION STATISTICS:\n`;
            content += `- Final Score: ${score}%\n`;
            content += `- Good Moves: ${currentSession.goodMoves}\n`;
            content += `- Bad Moves: ${currentSession.badMoves}\n`;
            content += `- Total Exchanges: ${Math.floor(currentSession.conversation.length / 2)}\n\n`;
            content += "=".repeat(60) + "\n\n";
            content += `STRENGTHS:\n${strengths}\n\n`;
            content += `AREAS FOR IMPROVEMENT:\n${improvements}\n\n`;
            content += "=".repeat(60) + "\n\n";
            content += `NEXT STEPS:\n`;
            content += `- Review this feedback with your supervisor\n`;
            content += `- Practice scenarios where you scored below 70%\n`;
            content += `- Focus on the improvement areas mentioned above\n`;
            content += `- Complete 2-3 training sessions per week for best results\n`;

            downloadFile(`Spring_Touch_Feedback_${new Date().toISOString().split('T')[0]}.txt`, content);
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }        async function saveSession(session) {
            if (supabaseClient && useDatabase) {
                try {
                    await saveSessionToDatabase(session);
                } catch (error) {
                    console.error('Database save failed, using localStorage:', error);
                    saveSessionToLocalStorage(session);
                }
            } else {
                saveSessionToLocalStorage(session);
            }
        }

        async function saveSessionToDatabase(session) {
            // Get or create agent
            let { data: agent, error: fetchError } = await supabaseClient
                .from('agents')
                .select('id')
                .eq('name', currentUser)
                .maybeSingle();

            let agentId;
            if (!agent) {
                const { data: newAgent, error: insertError } = await supabaseClient
                    .from('agents')
                    .insert([{ 
                        name: currentUser,
                        last_active: new Date().toISOString()
                    }])
                    .select()
                    .single();

                if (insertError) throw insertError;
                agentId = newAgent.id;
            } else {
                agentId = agent.id;
                
                // Update last_active
                await supabaseClient
                    .from('agents')
                    .update({ last_active: new Date().toISOString() })
                    .eq('id', agentId);
            }

            // Save session to database
            const { error: sessionError } = await supabaseClient
                .from('sessions')
                .insert([{
                    agent_id: agentId,
                    agent_name: currentUser,
                    scenario: session.scenario,
                    scenario_name: session.scenarioName || session.scenario,
                    start_time: session.startTime,
                    end_time: session.endTime,
                    score: session.score,
                    good_moves: session.goodMoves || 0,
                    bad_moves: session.badMoves || 0,
                    conversation: session.conversation
                }]);

            if (sessionError) throw sessionError;

            // Update agent stats
            await updateAgentStatsInDatabase(agentId);

            console.log('‚úÖ Session saved to centralized database');
            showDatabaseNotification('üíæ Session saved to team database!', 'success');
        }

        async function updateAgentStatsInDatabase(agentId) {
            try {
                const { data: sessions, error } = await supabaseClient
                    .from('sessions')
                    .select('*')
                    .eq('agent_id', agentId)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                if (!sessions || sessions.length === 0) return;

                const totalSessions = sessions.length;
                const avgScore = sessions.reduce((sum, s) => sum + s.score, 0) / totalSessions;

                // Find best scenario
                const scenarioScores = {};
                sessions.forEach(s => {
                    if (!scenarioScores[s.scenario]) scenarioScores[s.scenario] = [];
                    scenarioScores[s.scenario].push(s.score);
                });

                let bestScenario = '-';
                let bestAvg = 0;
                Object.keys(scenarioScores).forEach(scenario => {
                    const avg = scenarioScores[scenario].reduce((a, b) => a + b, 0) / scenarioScores[scenario].length;
                    if (avg > bestAvg) {
                        bestAvg = avg;
                        bestScenario = scenario;
                    }
                });

                // Calculate improvement
                let improvement = 0;
                if (sessions.length >= 4) {
                    const recent = sessions.slice(-3);
                    const earlier = sessions.slice(0, -3);
                    const recentAvg = recent.reduce((sum, s) => sum + s.score, 0) / recent.length;
                    const earlierAvg = earlier.reduce((sum, s) => sum + s.score, 0) / earlier.length;
                    improvement = ((recentAvg - earlierAvg) / earlierAvg) * 100;
                }

                // Determine skill level
                let skillLevel = 'Beginner';
                if (avgScore >= 80 && totalSessions >= 10) skillLevel = 'Expert';
                else if (avgScore >= 70 && totalSessions >= 5) skillLevel = 'Advanced';
                else if (avgScore >= 60 && totalSessions >= 3) skillLevel = 'Intermediate';

                // Update agent record
                await supabaseClient
                    .from('agents')
                    .update({
                        total_sessions: totalSessions,
                        avg_score: parseFloat(avgScore.toFixed(2)),
                        best_scenario: bestScenario,
                        improvement: parseFloat(improvement.toFixed(2)),
                        skill_level: skillLevel
                    })
                    .eq('id', agentId);

            } catch (error) {
                console.error('Error updating agent stats:', error);
            }
        }

        function saveSessionToLocalStorage(session) {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            
            if (!users[currentUser]) {
                users[currentUser] = {
                    sessions: [],
                    totalSessions: 0,
                    avgScore: 0,
                    bestScenario: '-',
                    improvement: 0,
                    level: 'Beginner'
                };
            }

            users[currentUser].sessions.push(session);
            users[currentUser].totalSessions++;
            
            const scores = users[currentUser].sessions.map(s => s.score);
            users[currentUser].avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            
            const scenarioCounts = {};
            users[currentUser].sessions.forEach(s => {
                scenarioCounts[s.scenario] = (scenarioCounts[s.scenario] || 0) + 1;
            });
            users[currentUser].bestScenario = Object.keys(scenarioCounts).reduce((a, b) => 
                scenarioCounts[a] > scenarioCounts[b] ? a : b
            );

            if (scores.length >= 2) {
                const recent = scores.slice(-3).reduce((a, b) => a + b, 0) / Math.min(3, scores.length);
                const earlier = scores.slice(0, -3).reduce((a, b) => a + b, 0) / Math.max(1, scores.length - 3);
                users[currentUser].improvement = Math.round(recent - earlier);
            }

            const avgScore = users[currentUser].avgScore;
            const totalSessions = users[currentUser].totalSessions;
            users[currentUser].level = 
                avgScore >= 80 && totalSessions >= 10 ? 'Expert' :
                avgScore >= 70 && totalSessions >= 5 ? 'Advanced' :
                avgScore >= 60 && totalSessions >= 3 ? 'Intermediate' :
                'Beginner';

            localStorage.setItem('springtouch_users', JSON.stringify(users));
        }

        function saveSession(session) {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            
            if (!users[currentUser]) {
                users[currentUser] = {
                    sessions: [],
                    totalSessions: 0,
                    avgScore: 0,
                    bestScenario: '-',
                    improvement: 0,
                    level: 'Beginner'
                };
            }

            users[currentUser].sessions.push(session);
            users[currentUser].totalSessions++;
            
            const scores = users[currentUser].sessions.map(s => s.score);
            users[currentUser].avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            
            const scenarioCounts = {};
            users[currentUser].sessions.forEach(s => {
                scenarioCounts[s.scenario] = (scenarioCounts[s.scenario] || 0) + 1;
            });
            users[currentUser].bestScenario = Object.keys(scenarioCounts).reduce((a, b) => 
                scenarioCounts[a] > scenarioCounts[b] ? a : b
            );

            if (scores.length >= 2) {
                const recent = scores.slice(-3).reduce((a, b) => a + b, 0) / Math.min(3, scores.length);
                const earlier = scores.slice(0, -3).reduce((a, b) => a + b, 0) / Math.max(1, scores.length - 3);
                users[currentUser].improvement = Math.round(recent - earlier);
            }

            // Calculate level
            const avgScore = users[currentUser].avgScore;
            const totalSessions = users[currentUser].totalSessions;
            users[currentUser].level = 
                avgScore >= 80 && totalSessions >= 10 ? 'Expert' :
                avgScore >= 70 && totalSessions >= 5 ? 'Advanced' :
                avgScore >= 60 && totalSessions >= 3 ? 'Intermediate' :
                'Beginner';

            localStorage.setItem('springtouch_users', JSON.stringify(users));
        }

        function loadHistory() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (!user || user.sessions.length === 0) {
                document.getElementById('historyList').innerHTML = '<p style="color: #a0aec0; text-align: center;">No training sessions yet.</p>';
                return;
            }

            let html = '';
            [...user.sessions].reverse().forEach((session, index) => {
                const date = new Date(session.startTime).toLocaleString();
                
                // Get scenario data (handle arrays)
                let scenarioData = SCENARIOS[session.scenario];
                if (Array.isArray(scenarioData)) {
                    scenarioData = scenarioData[0];
                }
                
                const scenarioName = session.scenarioName || scenarioData.name;
                const difficulty = scenarioData.difficulty;
                
                html += `
                    <div class="history-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${scenarioName}</strong>
                                <span class="difficulty-badge ${difficulty}">${difficulty}</span>
                                <div class="date">${date}</div>
                                <div style="color: #4a5568; font-size: 0.9em; margin-top: 5px;">
                                    ${session.goodMoves || 0} good moves, ${session.badMoves || 0} bad moves
                                </div>
                            </div>
                            <div class="score">${session.score}%</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('historyList').innerHTML = html;
        }

        function loadInsights() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (!user || user.sessions.length < 3) {
                return;
            }

            const scores = user.sessions.map(s => s.score);
            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;

            document.getElementById('strengths').textContent = 
                avgScore > 75 ? 'Excellent retention skills overall! Strong empathy and solution offering.' :
                avgScore > 60 ? 'Good empathy and problem-solving. Consistent performance.' :
                'Building foundation skills. Keep practicing!';

            document.getElementById('focusAreas').textContent = 
                avgScore < 60 ? 'Work on empathy statements and offering specific solutions' :
                avgScore < 75 ? 'Try more difficult scenarios to challenge yourself' :
                'Maintain consistency. Consider mentoring newer agents.';

            const trend = scores.slice(-3).reduce((a, b) => a + b) / 3 - scores.slice(0, 3).reduce((a, b) => a + b) / 3;
            document.getElementById('progressTrend').textContent = 
                trend > 10 ? 'üìà Improving significantly! Up ' + Math.round(trend) + '% from early sessions' :
                trend > 0 ? '‚û°Ô∏è Steady improvement. Up ' + Math.round(trend) + '%' :
                trend > -5 ? 'üìä Maintaining performance' :
                'üìâ Slight decline. Consider refresher training.';

            document.getElementById('recommended').textContent = 
                'Try ' + (user.bestScenario === 'financial' ? 'bad_service' : 'financial') + ' scenarios to broaden skills';

            // Training velocity
            const lastSession = new Date(user.sessions[user.sessions.length - 1].startTime);
            const firstSession = new Date(user.sessions[0].startTime);
            const daysBetween = Math.floor((lastSession - firstSession) / (1000 * 60 * 60 * 24)) || 1;
            const sessionsPerWeek = (user.sessions.length / daysBetween * 7).toFixed(1);
            document.getElementById('velocity').textContent = sessionsPerWeek + ' sessions/week';

            document.getElementById('skillLevel').textContent = user.level;
        }

        function loadLeaderboard() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const leaderboard = Object.keys(users)
                .map(name => ({
                    name: name,
                    avgScore: users[name].avgScore,
                    sessions: users[name].totalSessions,
                    level: users[name].level
                }))
                .sort((a, b) => b.avgScore - a.avgScore)
                .slice(0, 10);

            if (leaderboard.length === 0) {
                document.getElementById('leaderboardList').innerHTML = '<p style="color: #a0aec0; text-align: center;">No data yet.</p>';
                return;
            }

            let html = '';
            leaderboard.forEach((user, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                html += `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">${medal || (index + 1)}</div>
                        <div class="leaderboard-name">
                            ${user.name}
                            <div style="font-size: 0.8em; color: #718096;">${user.level}</div>
                        </div>
                        <div class="leaderboard-score">${user.avgScore}%</div>
                        <div style="color: #718096; font-size: 0.9em;">${user.sessions} sessions</div>
                    </div>
                `;
            });

            document.getElementById('leaderboardList').innerHTML = html;
        }

        function loadTeamAnalytics() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const allUsers = Object.values(users);
            
            if (allUsers.length === 0) {
                return;
            }

            const totalSessions = allUsers.reduce((sum, u) => sum + u.totalSessions, 0);
            const avgScore = Math.round(allUsers.reduce((sum, u) => sum + u.avgScore, 0) / allUsers.length);
            const activeAgents = allUsers.filter(u => u.totalSessions > 0).length;
            
            const allScores = allUsers.flatMap(u => u.sessions.map(s => s.score));
            const recentScores = allScores.slice(-20);
            const earlierScores = allScores.slice(0, -20);
            const improvement = recentScores.length > 0 && earlierScores.length > 0 ?
                Math.round(recentScores.reduce((a, b) => a + b) / recentScores.length - 
                           earlierScores.reduce((a, b) => a + b) / earlierScores.length) : 0;

            document.getElementById('teamTotalSessions').textContent = totalSessions;
            document.getElementById('teamAvgScore').textContent = avgScore + '%';
            document.getElementById('teamActiveAgents').textContent = activeAgents;
            document.getElementById('teamImprovement').textContent = improvement > 0 ? '+' + improvement + '%' : improvement + '%';

            // Scenario performance
            const scenarioScores = {};
            allUsers.forEach(user => {
                user.sessions.forEach(session => {
                    if (!scenarioScores[session.scenario]) scenarioScores[session.scenario] = [];
                    scenarioScores[session.scenario].push(session.score);
                });
            });

            Object.keys(scenarioScores).forEach(scenario => {
                const scores = scenarioScores[scenario];
                const avg = Math.round(scores.reduce((a, b) => a + b) / scores.length);
                const elementId = scenario + 'Perf';
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = `Avg: ${avg}% (${scores.length} attempts)`;
                }
            });

            // Agents needing support
            const needsSupport = allUsers.filter(u => u.avgScore < 60 || u.improvement < -5);
            if (needsSupport.length > 0) {
                let html = '<ul>';
                needsSupport.forEach(user => {
                    html += `<li><strong>${user.name}</strong> - Avg: ${user.avgScore}%, Trend: ${user.improvement}%</li>`;
                });
                html += '</ul>';
                document.getElementById('needsSupport').innerHTML = html;
            }
        }

        function loadManagerDashboard() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const allUsers = Object.entries(users).map(([name, data]) => ({
                name,
                ...data
            }));

            if (allUsers.length === 0) {
                return;
            }

            let tableHtml = '';
            allUsers.forEach(user => {
                const lastSession = user.sessions.length > 0 ? 
                    new Date(user.sessions[user.sessions.length - 1].startTime).toLocaleDateString() : 
                    'Never';
                
                const status = user.improvement > 5 ? '‚úÖ Improving' :
                               user.improvement < -5 ? '‚ö†Ô∏è Declining' :
                               user.avgScore > 70 ? '‚úì Good' : '‚ö†Ô∏è Needs Support';

                const statusColor = user.improvement > 5 ? '#10b981' :
                                   user.improvement < -5 ? '#f59e0b' :
                                   user.avgScore > 70 ? '#4a7c2c' : '#ef4444';

                tableHtml += `
                    <tr>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.totalSessions}</td>
                        <td>
                            ${user.avgScore}%
                            <div class="progress-bar" style="margin-top: 5px;">
                                <div class="progress-fill" style="width: ${user.avgScore}%"></div>
                            </div>
                        </td>
                        <td style="color: ${user.improvement > 0 ? '#10b981' : '#ef4444'}">
                            ${user.improvement > 0 ? '+' : ''}${user.improvement}%
                        </td>
                        <td>${lastSession}</td>
                        <td style="color: ${statusColor}; font-weight: 600;">${status}</td>
                    </tr>
                `;
            });

            document.getElementById('agentTableBody').innerHTML = tableHtml;

            // Action items
            const declining = allUsers.filter(u => u.improvement < -5).length;
            const needsTraining = allUsers.filter(u => u.avgScore < 60).length;
            const inactive = allUsers.filter(u => {
                if (u.sessions.length === 0) return true;
                const lastSession = new Date(u.sessions[u.sessions.length - 1].startTime);
                const daysSince = (Date.now() - lastSession) / (1000 * 60 * 60 * 24);
                return daysSince > 7;
            }).length;

            let actionItems = [];
            if (declining > 0) actionItems.push(`${declining} agent(s) showing declining performance`);
            if (needsTraining > 0) actionItems.push(`${needsTraining} agent(s) below 60% average`);
            if (inactive > 0) actionItems.push(`${inactive} agent(s) inactive for 7+ days`);

            document.getElementById('actionItems').textContent = 
                actionItems.length > 0 ? actionItems.join(' ‚Ä¢ ') : 'All agents performing well!';
        }

        function exportMyData() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (!user || user.sessions.length === 0) {
                alert('No data to export');
                return;
            }

            const data = user.sessions.map(session => ({
                'Date': new Date(session.startTime).toLocaleString(),
                'Scenario': SCENARIOS[session.scenario].name,
                'Difficulty': SCENARIOS[session.scenario].difficulty,
                'Score': session.score + '%',
                'Good Moves': session.goodMoves,
                'Bad Moves': session.badMoves,
                'Exchanges': Math.floor(session.conversation.length / 2)
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Training History');
            XLSX.writeFile(wb, `${currentUser}_Training_History_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportTeamData() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            
            const summary = Object.entries(users).map(([name, data]) => ({
                'Agent Name': name,
                'Total Sessions': data.totalSessions,
                'Average Score': data.avgScore + '%',
                'Best Scenario': data.bestScenario,
                'Improvement': data.improvement + '%',
                'Level': data.level || 'Beginner'
            }));

            const allSessions = [];
            Object.entries(users).forEach(([name, data]) => {
                data.sessions.forEach(session => {
                    allSessions.push({
                        'Agent': name,
                        'Date': new Date(session.startTime).toLocaleString(),
                        'Scenario': SCENARIOS[session.scenario].name,
                        'Score': session.score + '%',
                        'Good Moves': session.goodMoves,
                        'Bad Moves': session.badMoves
                    });
                });
            });

            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.json_to_sheet(summary);
            const ws2 = XLSX.utils.json_to_sheet(allSessions);
            XLSX.utils.book_append_sheet(wb, ws1, 'Team Summary');
            XLSX.utils.book_append_sheet(wb, ws2, 'All Sessions');
            XLSX.writeFile(wb, `Spring_Touch_Team_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            document.getElementById('uploadZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.match('audio.*')) {
                    const call = {
                        name: file.name,
                        size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                        uploadDate: new Date().toLocaleString(),
                        processed: false
                    };
                    
                    uploadedCalls.push(call);
                    displayUploadedCalls();
                }
            });
        }

        function displayUploadedCalls() {
            let html = '<h3 style="margin-top: 20px;">Uploaded Calls</h3>';
            uploadedCalls.forEach((call, index) => {
                html += `
                    <div class="call-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üé§ ${call.name}</strong>
                                <div style="color: #718096; font-size: 0.9em;">${call.size} ‚Ä¢ ${call.uploadDate}</div>
                            </div>
                            <div>
                                ${call.processed ? 
                                    '<span class="badge" style="background: #10b981;">‚úì Processed</span>' : 
                                    '<span class="badge" style="background: #f59e0b;">‚è≥ Processing...</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('callList').innerHTML = html;

            // Simulate processing
            setTimeout(() => {
                uploadedCalls.forEach(call => call.processed = true);
                displayUploadedCalls();
            }, 3000);
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
    </script>
</body>
</html>
